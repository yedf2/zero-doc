"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[989],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(n),m=i,k=u["".concat(s,".").concat(m)]||u[m]||c[m]||r;return n?a.createElement(k,o(o({ref:t},d),{},{components:n})):a.createElement(k,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},8144:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return d},default:function(){return u}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],l={sidebar_position:6},s="Service Deployment",p={unversionedId:"project/deploy",id:"project/deploy",title:"Service Deployment",description:"This section does a simple service deployment to k8s demo via jenkins.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/project/deploy.md",sourceDirName:"project",slug:"/project/deploy",permalink:"/en/docs/project/deploy",editUrl:"https://github.com/zhoushuguang/zero-doc/tree/main/website/i18n/en/docusaurus-plugin-content-docs/current/project/deploy.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"CI/CD",permalink:"/en/docs/project/cicd"},next:{title:"Log collection",permalink:"/en/docs/project/log"}},d=[{value:"Preparation",id:"preparation",children:[],level:2},{value:"Service deployment",id:"service-deployment-1",children:[{value:"1. gitlab code repository related preparation",id:"1-gitlab-code-repository-related-preparation",children:[{value:"1.1. Add SSH Key",id:"11-add-ssh-key",children:[],level:4},{value:"1.2, upload the code to the gitlab repository",id:"12-upload-the-code-to-the-gitlab-repository",children:[],level:4}],level:3},{value:"2. jenkins",id:"2-jenkins",children:[{value:"2.1\u3001Add credentials",id:"21add-credentials",children:[],level:4},{value:"2.2. Adding global variables",id:"22-adding-global-variables",children:[],level:4},{value:"2.3. Configure git",id:"23-configure-git",children:[],level:4},{value:"2.4. Adding a Pipeline",id:"24-adding-a-pipeline",children:[],level:4}],level:3}],level:2}],c={toc:d};function u(e){var t=e.components,l=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"service-deployment"},"Service Deployment"),(0,r.kt)("p",null,"This section does a simple service deployment to k8s demo via jenkins."),(0,r.kt)("h2",{id:"preparation"},"Preparation"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"k8s cluster installation"),(0,r.kt)("li",{parentName:"ul"},"gitlab environment installation"),(0,r.kt)("li",{parentName:"ul"},"jenkins environment installation"),(0,r.kt)("li",{parentName:"ul"},"redis&mysql&nginx&etcd installation"),(0,r.kt)("li",{parentName:"ul"},"goctl installation")),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"goctl ensures that k8s is available on every node"),(0,r.kt)("p",{parentName:"div"},"Please google the above environment installation by yourself, no lengthy introduction here."))),(0,r.kt)("h2",{id:"service-deployment-1"},"Service deployment"),(0,r.kt)("h3",{id:"1-gitlab-code-repository-related-preparation"},"1. gitlab code repository related preparation"),(0,r.kt)("h4",{id:"11-add-ssh-key"},"1.1. Add SSH Key"),(0,r.kt)("p",null,"Go to gitlab, click User Center, find ",(0,r.kt)("inlineCode",{parentName:"p"},"Settings"),", find ",(0,r.kt)("inlineCode",{parentName:"p"},"SSH Keys")," tab on the left side\n! ",(0,r.kt)("a",{target:"_blank",href:n(1862).Z},"ssh key")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"View the public key on the machine where jenkins is located")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ cat ~/.ssh/id_rsa.pub\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:2},(0,r.kt)("li",{parentName:"ol"},"If not, you need to generate it, if it exists, skip to step 3")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'$ ssh-keygen -t rsa -b 2048 -C "email@example.com"\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},'"',(0,r.kt)("a",{parentName:"p",href:"mailto:email@example.com"},"email@example.com"),'" can be replaced with your own email'),(0,r.kt)("p",{parentName:"blockquote"},"After finishing the generation, repeat the first step")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("ol",{parentName:"li",start:3},(0,r.kt)("li",{parentName:"ol"},"Add the public key to gitlab")))),(0,r.kt)("h4",{id:"12-upload-the-code-to-the-gitlab-repository"},"1.2, upload the code to the gitlab repository"),(0,r.kt)("p",null,"Create a new project ",(0,r.kt)("inlineCode",{parentName:"p"},"go-zero-demo")," and upload the code, no details are described here."),(0,r.kt)("h3",{id:"2-jenkins"},"2. jenkins"),(0,r.kt)("h4",{id:"21add-credentials"},"2.1\u3001Add credentials"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the private key of the machine where jenkins is located, corresponding to the previous gitlab public key")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ cat id_rsa\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to jenkins and click ",(0,r.kt)("inlineCode",{parentName:"p"},"Manage Jenkins"),"-> ",(0,r.kt)("inlineCode",{parentName:"p"},"Manage Credentials")," in order\n! ",(0,r.kt)("a",{target:"_blank",href:n(9209).Z},"credentials"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Global Credentials")," page, add credentials, ",(0,r.kt)("inlineCode",{parentName:"p"},"Username")," is an identifier, after adding the pipeline you know that this identifier is the credentials on behalf of gitlab on the line, Private Key",(0,r.kt)("inlineCode",{parentName:"p"}," that is, the private key obtained above\nPrivate Key")," is the private key obtained above! ",(0,r.kt)("a",{target:"_blank",href:n(4587).Z},"jenkins-add-credentials")))),(0,r.kt)("h4",{id:"22-adding-global-variables"},"2.2. Adding global variables"),(0,r.kt)("p",null,"Go to ",(0,r.kt)("inlineCode",{parentName:"p"},"Manage Jenkins"),"->",(0,r.kt)("inlineCode",{parentName:"p"},"Configure System"),", slide to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Global Properties")," entry, add information about the docker private repository, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"docker user name"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"docker user password"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"docker private repository address")," as shown here\n! ",(0,r.kt)("a",{target:"_blank",href:n(7232).Z},"docker_server")),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},(0,r.kt)("inlineCode",{parentName:"p"},"docker_user")," change to your docker username"),(0,r.kt)("p",{parentName:"div"},(0,r.kt)("inlineCode",{parentName:"p"},"docker_pass")," change to your docker user password"),(0,r.kt)("p",{parentName:"div"},(0,r.kt)("inlineCode",{parentName:"p"},"docker_server")," change to your docker server address"),(0,r.kt)("p",{parentName:"div"},"Here I use a private repository, if there is no cloud vendor to provide a private repository to use, you can build a private repository by yourself, here will not repeat, we google."))),(0,r.kt)("h4",{id:"23-configure-git"},"2.3. Configure git"),(0,r.kt)("p",null,"Go to ",(0,r.kt)("inlineCode",{parentName:"p"},"Manage Jenkins"),"->",(0,r.kt)("inlineCode",{parentName:"p"},"Global Tool Configureation"),", find the Git entry, fill in the path of the git executable on the machine where jenkins is located, if not, you need to download the Git plugin in jenkins plugin management.\n! ",(0,r.kt)("a",{target:"_blank",href:n(9413).Z},"jenkins-git")),(0,r.kt)("p",null,"! ",(0,r.kt)("a",{target:"_blank",href:n(7440).Z},"jenkins-configure")),(0,r.kt)("h4",{id:"24-adding-a-pipeline"},"2.4. Adding a Pipeline"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"pipeline is used to build the project, pulling code from gitlab -> generating Dockerfile -> deploying to k8s are all done in this step, here is the demo environment, to ensure smooth deployment process\nTo ensure a smooth deployment process, you need to install jenkins on the machine where one of the nodes in the k8s cluster is located, I installed it on the master here.")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Get the credentials id Go to the credentials page and find the credentials id with Username as ",(0,r.kt)("inlineCode",{parentName:"p"},"gitlab"),"\n! ",(0,r.kt)("a",{target:"_blank",href:n(5633).Z},"jenkins-credentials-id"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to the jenkins home page and click ",(0,r.kt)("inlineCode",{parentName:"p"},"New Item")," with the name ",(0,r.kt)("inlineCode",{parentName:"p"},"user"),"\n! ",(0,r.kt)("a",{target:"_blank",href:n(7237).Z},"jenkins-add-item"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"View the project git address\n! ",(0,r.kt)("a",{target:"_blank",href:n(8083).Z},"gitlab-git-url"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Add the service type Choice Parameter, check ",(0,r.kt)("inlineCode",{parentName:"p"},"This project is parameterized in General\n"),", click ",(0,r.kt)("inlineCode",{parentName:"p"},"Add Parameter")," and select ",(0,r.kt)("inlineCode",{parentName:"p"},"Choice Parameter"),", add the selected value constants (api, rpc) and the variables (type) to receive the values according to the diagram, which will be used later in the Pipeline script.\n! ",(0,r.kt)("a",{target:"_blank",href:n(3426).Z},"jenkins-choice-parameter"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Configure ",(0,r.kt)("inlineCode",{parentName:"p"},"user"),", on the ",(0,r.kt)("inlineCode",{parentName:"p"},"user")," configuration page, scroll down and find ",(0,r.kt)("inlineCode",{parentName:"p"},"Pipeline script"),", fill in the script content"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"pipeline {\n  agent any\n  parameters {\n      gitParameter name: 'branch', \n      type: 'PT_BRANCH',\n      branchFilter: 'origin/(. *)',\n      defaultValue: 'master',\n      selectedValue: 'DEFAULT',\n      sortMode: 'ASCENDING_SMART',\n      description: 'Select the branch to build'\n  }\n\n  stages {\n      stage('Service information') {\n          steps {\n              sh 'echo branch: $branch'\n              sh 'echo build service type: ${JOB_NAME}-$type'\n          }\n      }\n\n\n      stage('check out') {\n          steps {\n              checkout([$class: 'GitSCM', \n              branches: [[name: '$branch']],\n              doGenerateSubmoduleConfigurations: false, \n              extensions: [], \n              submoduleCfg: [],\n              userRemoteConfigs: [[credentialsId: '${credentialsId}', url: '${gitUrl}']]])\n          }   \n      }\n\n      stage('get_commit_id') {\n          steps {\n              echo 'get commit_id'\n              git credentialsId: '${credentialsId}', url: '${gitUrl}'\n              script {\n                  env.commit_id = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()\n              }\n          }\n      }\n\n\n      stage('goctl version detection') {\n          steps{\n              sh '/usr/local/bin/goctl -v'\n          }\n      }\n\n      stage('Dockerfile Build') {\n          steps{\n                 sh '/usr/local/bin/goctl docker -go service/${JOB_NAME}/${type}/${JOB_NAME}.go'\n                 script{\n                     env.image = sh(returnStdout: true, script: 'echo ${JOB_NAME}-${type}:${commit_id}').trim()\n                 }\n                 sh 'echo image name: ${image}'\n                 sh 'docker build -t ${image} .'\n          }\n      }\n\n      stage('upload to image repository') {\n          steps{\n              sh '/root/dockerlogin.sh'\n              sh 'docker tag ${image} ${dockerServer}/${image}'\n              sh 'docker push ${dockerServer}/${image}'\n          }\n      }\n\n      stage('deploy to k8s') {\n          steps{\n              script{\n                  env.deployYaml = sh(returnStdout: true, script: 'echo ${JOB_NAME}-${type}-deploy.yaml').trim()\n                  env.port=sh(returnStdout: true, script: '/root/port.sh ${JOB_NAME}-${type}').trim()\n              }\n\n              sh 'echo ${port}'\n\n              sh 'rm -f ${deployYaml}'\n              sh '/usr/local/bin/goctl kube deploy -secret dockersecret -replicas 2 -nodePort 3${port} -requestCpu 200 -requestMem 50 -limitCpu 300 -limitMem 100 -name ${JOB_NAME}-${type} -namespace hey-go-zero -image ${dockerServer}/${image} -o ${deployYaml} -port ${port}'\n              sh '/usr/bin/kubectl apply -f ${deployYaml}'\n          }\n      }\n      \n      stage('Clean') {\n          steps{\n              sh 'docker rmi -f ${image}'\n              sh 'docker rmi -f ${dockerServer}/${image}'\n              cleanWs notFailBuild: true\n          }\n      }\n  }\n")))}u.isMDXComponent=!0},7232:function(e,t,n){t.Z=n.p+"assets/files/docker_env-041478b5f3401eaa8984c63a0b0eb39d.png"},8083:function(e,t,n){t.Z=n.p+"assets/files/gitlab-git-url-f1da68812c259d6a79ae1d6d56dbcb2e.png"},4587:function(e,t,n){t.Z=n.p+"assets/files/jenkins-add-credentials-6571e3a1892342babe2aff11383cd4cf.png"},3426:function(e,t,n){t.Z=n.p+"assets/files/jenkins-choice-74208d911d8e87e8b3c334623f622b76.png"},7440:function(e,t,n){t.Z=n.p+"assets/files/jenkins-configure-67327d264092ef27617d7f04d1d4383a.png"},5633:function(e,t,n){t.Z=n.p+"assets/files/jenkins-credentials-id-375cada8d4e2bc0b9595ea1075115037.png"},9209:function(e,t,n){t.Z=n.p+"assets/files/jenkins-credentials-67c5d02d364de9ce359864a183f9dbb2.png"},9413:function(e,t,n){t.Z=n.p+"assets/files/jenkins-git-2704493865e8f639ed334c1db8ce48a9.png"},7237:function(e,t,n){t.Z=n.p+"assets/files/jenkins-new-item-c75773b46b1a19c8497bfa7e2ec44052.png"},1862:function(e,t,n){t.Z=n.p+"assets/files/ssh-add-key-1fc91c396e8e927e4345207f6cfb1869.png"}}]);