"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[5467],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,g=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return n?a.createElement(g,o(o({ref:t},p),{},{components:n})):a.createElement(g,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9694:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return p},default:function(){return u}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],s={sidebar_position:7},l="Log collection",c={unversionedId:"project/log",id:"project/log",title:"Log collection",description:"To ensure stable business operation and predict the risk of unhealthy services, log collection can help us to have a good observation of the current service health.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/project/log.md",sourceDirName:"project",slug:"/project/log",permalink:"/en/docs/project/log",editUrl:"https://github.com/zhoushuguang/zero-doc/tree/main/website/i18n/en/docusaurus-plugin-content-docs/current/project/log.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Service Deployment",permalink:"/en/docs/project/deploy"},next:{title:"Intellij Plugin",permalink:"/en/docs/ecology/intellij"}},p=[{value:"Preparation",id:"preparation",children:[],level:2},{value:"filebeat configuration",id:"filebeat-configuration",children:[],level:2},{value:"go-stash configuration",id:"go-stash-configuration",children:[],level:2},{value:"Start services (in order)",id:"start-services-in-order",children:[],level:2},{value:"Access kibana",id:"access-kibana",children:[],level:2}],d={toc:p};function u(e){var t=e.components,s=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"log-collection"},"Log collection"),(0,i.kt)("p",null,"To ensure stable business operation and predict the risk of unhealthy services, log collection can help us to have a good observation of the current service health.\nIn traditional business development, when there are not many machines deployed yet, we usually log into the server directly to view and debug the logs, but as the business grows and the services are continuously split, the\nThe maintenance cost of the service will also become more and more complicated. In a distributed system, the number of server machines increases and the service is distributed on different servers, when problems are encountered\nWe can't use the traditional practice of logging in to the server for logging and debugging, which is a complexity that can be imagined.\n",(0,i.kt)("img",{alt:"log-flow",src:n(4006).Z})),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"It is not recommended to use it directly if it is a simple monolithic service system or if the service is too small, otherwise it will be counterproductive."))),(0,i.kt)("h2",{id:"preparation"},"Preparation"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"kafka"),(0,i.kt)("li",{parentName:"ul"},"elasticsearch"),(0,i.kt)("li",{parentName:"ul"},"kibana"),(0,i.kt)("li",{parentName:"ul"},"filebeat, Log-Pilot (k8s)"),(0,i.kt)("li",{parentName:"ul"},"go-stash")),(0,i.kt)("h2",{id:"filebeat-configuration"},"filebeat configuration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim xx/filebeat.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"filebeat.inputs:\n- type: log\n  enabled: true\n  # enable json parsing\n  json.keys_under_root: true\n  json.add_error_key: true\n  # Log file paths\n  paths:\n    - /var/log/order/*.log\n\nsetup.template.settings:\n  index.number_of_shards: 1\n\n# Define kafka topic field\nfields:\n  log_topic: log-collection\n\n# Output to kafka\noutput.kafka:\n  hosts: [\"127.0.0.1:9092\"]\n  topic: '%{[fields.log_topic]}'\n  partition.round_robin:\n    reachable_only: false\n  required_acks: 1\n  keep_alive: 10s\n\n# ================================= Processors =================================\nprocessors:\n  - decode_json_fields:\n      fields: ['@timestamp','level','content','trace','span','duration']\n      target: \"\"\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"xx is the path where filebeat.yaml is located"))),(0,i.kt)("h2",{id:"go-stash-configuration"},"go-stash configuration"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Create a new ",(0,i.kt)("inlineCode",{parentName:"li"},"config.yaml")," file"),(0,i.kt)("li",{parentName:"ul"},"Add configuration content")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim config.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'Clusters:\n- Input:\n    Kafka:\n      Name: go-stash\n      Log:\n        Mode: file\n      Brokers:\n      - "127.0.0.1:9092"\n      Topics: \n      - log-collection\n      Group: stash\n      Conns: 3\n      Consumers: 10\n      Processors: 60\n      MinBytes: 1048576\n      MaxBytes: 10485760\n      Offset: first\n  Filters:\n  - Action: drop\n    Conditions:\n      - Key: status\n        Value: "503"\n        Type: contains\n      - Key: type\n        Value: "app"\n        Type: match\n        Op: and\n  - Action: remove_field\n    Fields:\n    - source\n    - _score\n    - "@metadata"\n    - agent\n    - ecs\n    - input\n    - log\n    - fields\n  Output:\n    ElasticSearch:\n      Hosts:\n      - "http://127.0.0.1:9200"\n      Index: "go-stash-{{yyyy.MM.dd}}"\n      MaxChunkBytes: 5242880\n      GracePeriod: 10s\n      Compress: false\n      TimeZone: UTC\n')),(0,i.kt)("h2",{id:"start-services-in-order"},"Start services (in order)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Start kafka"),(0,i.kt)("li",{parentName:"ul"},"Start elasticsearch"),(0,i.kt)("li",{parentName:"ul"},"Start kibana"),(0,i.kt)("li",{parentName:"ul"},"start go-stash"),(0,i.kt)("li",{parentName:"ul"},"start filebeat"),(0,i.kt)("li",{parentName:"ul"},"Start order-api service and its dependencies (order-api service in the go-zero-demo project)")),(0,i.kt)("h2",{id:"access-kibana"},"Access kibana"),(0,i.kt)("p",null,"Go to 127.0.0.1:5601\n",(0,i.kt)("img",{alt:"log",src:n(2028).Z})),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Here is a demonstration of collecting logs generated via logx in the service only, same for log collection in nginx."))))}u.isMDXComponent=!0},4006:function(e,t,n){t.Z=n.p+"assets/images/log-flow-1f6f33a2be1dae796cd6a0b6e0b7ca88.png"},2028:function(e,t,n){t.Z=n.p+"assets/images/log-06d93223e9b4e5d1de820c7037bfde53.png"}}]);