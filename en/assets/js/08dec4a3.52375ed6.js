"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[7526],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return u}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},d=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),m=c(t),u=r,h=m["".concat(l,".").concat(u)]||m[u]||p[u]||i;return t?a.createElement(h,s(s({ref:n},d),{},{components:t})):a.createElement(h,s({ref:n},d))}));function u(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,s=new Array(i);s[0]=m;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var c=2;c<i;c++)s[c]=t[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},13:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return d},default:function(){return m}});var a=t(7462),r=t(3366),i=(t(7294),t(3905)),s=["components"],o={sidebar_position:4},l="Business Development",c={unversionedId:"project/business",id:"project/business",title:"Business Development",description:"In this section we use a simple example to demonstrate some basic functionality in go-zero.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/project/business.md",sourceDirName:"project",slug:"/project/business",permalink:"/en/docs/project/business",editUrl:"https://github.com/zhoushuguang/zero-doc/tree/main/website/i18n/en/docusaurus-plugin-content-docs/current/project/business.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Configuration introduction",permalink:"/en/docs/project/config"},next:{title:"CI/CD",permalink:"/en/docs/project/cicd"}},d=[{value:"demo project download",id:"demo-project-download",children:[],level:2},{value:"Demo project description",id:"demo-project-description",children:[{value:"Scenario",id:"scenario",children:[],level:3},{value:"Expected to achieve the goal",id:"expected-to-achieve-the-goal",children:[],level:3},{value:"System analysis",id:"system-analysis",children:[{value:"Service splitting",id:"service-splitting",children:[],level:4},{value:"Reference preset data",id:"reference-preset-data",children:[],level:4}],level:3}],level:2},{value:"Directory splitting",id:"directory-splitting",children:[{value:"System structure analysis",id:"system-structure-analysis",children:[],level:3},{value:"rpc call chain suggestions",id:"rpc-call-chain-suggestions",children:[],level:3},{value:"Directory structure of common service types",id:"directory-structure-of-common-service-types",children:[],level:3},{value:"Example of the complete project directory structure",id:"example-of-the-complete-project-directory-structure",children:[],level:3}],level:2},{value:"model generation",id:"model-generation",children:[{value:"Preparation",id:"preparation",children:[],level:3},{value:"Code generation (with cache)",id:"code-generation-with-cache",children:[{value:"way one (ddl)",id:"way-one-ddl",children:[],level:4},{value:"way two(datasource)",id:"way-twodatasource",children:[],level:4},{value:"way three(intellij plugin)",id:"way-threeintellij-plugin",children:[],level:4}],level:3},{value:"Validate the generated model file",id:"validate-the-generated-model-file",children:[],level:3}],level:2},{value:"api file writing",id:"api-file-writing",children:[{value:"Write user.api file",id:"write-userapi-file",children:[],level:3},{value:"Generate api service",id:"generate-api-service",children:[{value:"way one",id:"way-one",children:[],level:4},{value:"way two",id:"way-two",children:[],level:4},{value:"way three",id:"way-three",children:[],level:4}],level:3}],level:2},{value:"Business coding",id:"business-coding",children:[{value:"Adding Mysql configuration",id:"adding-mysql-configuration",children:[],level:3},{value:"Improve yaml configuration",id:"improve-yaml-configuration",children:[],level:3},{value:"Perfect service dependence",id:"perfect-service-dependence",children:[],level:3},{value:"Populate login logic",id:"populate-login-logic",children:[],level:3}],level:2},{value:"jwt forensics",id:"jwt-forensics",children:[{value:"Overview",id:"overview",children:[],level:3},{value:"When should JWT be used",id:"when-should-jwt-be-used",children:[],level:3},{value:"Why use JSON Web tokens",id:"why-use-json-web-tokens",children:[],level:3},{value:"How to use jwt in go-zero",id:"how-to-use-jwt-in-go-zero",children:[{value:"user api generates jwt token",id:"user-api-generates-jwt-token",children:[{value:"Add configuration definition and yaml configuration items",id:"add-configuration-definition-and-yaml-configuration-items",children:[],level:5}],level:4},{value:"search api using jwt token authentication",id:"search-api-using-jwt-token-authentication",children:[{value:"writing search.api file",id:"writing-searchapi-file",children:[],level:5},{value:"Generating Code",id:"generating-code",children:[],level:5},{value:"Add yaml configuration items",id:"add-yaml-configuration-items",children:[],level:5}],level:4},{value:"verify jwt token",id:"verify-jwt-token",children:[],level:4},{value:"gets the information carried in the jwt token",id:"gets-the-information-carried-in-the-jwt-token",children:[],level:4}],level:3}],level:2},{value:"Middleware Usage",id:"middleware-usage",children:[{value:"Middleware classification",id:"middleware-classification",children:[],level:3},{value:"Middleware usage",id:"middleware-usage-1",children:[{value:"routing middleware",id:"routing-middleware",children:[],level:4},{value:"Global Middleware",id:"global-middleware",children:[],level:4},{value:"Calling other services from within the middleware",id:"calling-other-services-from-within-the-middleware",children:[],level:4}],level:3}],level:2},{value:"rpc writing and calling",id:"rpc-writing-and-calling",children:[{value:"Scenarios",id:"scenarios",children:[],level:3},{value:"rpc service writing",id:"rpc-service-writing",children:[],level:3},{value:"Using rpc",id:"using-rpc",children:[],level:3},{value:"Start and verify services",id:"start-and-verify-services",children:[],level:3}],level:2},{value:"Error Handling",id:"error-handling",children:[{value:"Business error response format",id:"business-error-response-format",children:[],level:3},{value:"user api login",id:"user-api-login",children:[],level:3},{value:"Custom errors",id:"custom-errors",children:[],level:3}],level:2}],p={toc:d};function m(e){var n=e.components,t=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"business-development"},"Business Development"),(0,i.kt)("p",null,"In this section we use a simple example to demonstrate some basic functionality in go-zero."),(0,i.kt)("h2",{id:"demo-project-download"},"demo project download"),(0,i.kt)("p",null,"Before we get into the rest of the documentation, take a look at the source code, which we will use to demonstrate the functionality incrementally.\nInstead of starting from zero, if you start from ","[quick-start]"," (... /quick-start/concept.md) chapter, this source structure will not be a problem for you."),(0,i.kt)("p",null,"Click ",(0,i.kt)("a",{href:"https://zeromicro.github.io/go-zero-pages/resource/book.zip"},"here to download the ")," demo project base source code"),(0,i.kt)("h2",{id:"demo-project-description"},"Demo project description"),(0,i.kt)("h3",{id:"scenario"},"Scenario"),(0,i.kt)("p",null,"Xiaoming, a programmer, needs to borrow a copy of Journey to the West. In the absence of an online library management system, he has to go to the front desk of the library every day to consult the librarian"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'Xiao Ming: Hello, is the book "Journey to the West" still available today?'),(0,i.kt)("li",{parentName:"ul"},"Administrator: No, come back tomorrow to check it out.")),(0,i.kt)("p",null,"After a day, Xiaoming came to the library again and asked."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'Xiaoming: Hello, is the book "Journey to the West" still available today?'),(0,i.kt)("li",{parentName:"ul"},"The administrator: No, you can come back in two days.")),(0,i.kt)("p",null,"So after many iterations, Xiao Ming was also futile, wasting a lot of time on the way back and forth, so finally could not stand the backward library management system.\nHe decided to make a book access system by himself."),(0,i.kt)("h3",{id:"expected-to-achieve-the-goal"},"Expected to achieve the goal"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"User login\nRely on existing student system data for login"),(0,i.kt)("li",{parentName:"ul"},"Book search\nSearch for books based on book keywords and check the number of books remaining.")),(0,i.kt)("h3",{id:"system-analysis"},"System analysis"),(0,i.kt)("h4",{id:"service-splitting"},"Service splitting"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"user",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"api provides user login protocol"),(0,i.kt)("li",{parentName:"ul"},"rpc for search service to access user data"))),(0,i.kt)("li",{parentName:"ul"},"search",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"api provides the book search protocol")))),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Although this tiny book checkout system is small and not quite in line with the business scenario from a practical point of view, the above two functions alone have satisfied our demonstration of the go-zero api/rpc scenario.\nLater, in order to meet the richer go-zero function demonstration, will be inserted in the document business that is related to the description of the function. Only one scenario is introduced here."),(0,i.kt)("p",{parentName:"div"},"Note: please create your own sql statements in user to the db, for more preparation see ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"/en/docs/project/prepare"},"preparation"))),(0,i.kt)("p",{parentName:"div"},"Add some preset user data to the database for later use. For the sake of space, the demo project does not do a detailed demonstration of such operations as inserting data."))),(0,i.kt)("h4",{id:"reference-preset-data"},"Reference preset data"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO `user` (number,name,password,gender)values ('666','\u5c0f\u660e','123456','\u7537');\n")),(0,i.kt)("h2",{id:"directory-splitting"},"Directory splitting"),(0,i.kt)("p",null,"Directory splitting refers to directory splitting in conjunction with go-zero's best practices, which is related to microservice splitting, and in the team's internal best practices\nWe split a system into multiple subsystems according to the business horizontal split, each subsystem should have independent persistent storage, caching system.\nFor example, a mall system needs to have a user system (user), product management system (product), order system (order), shopping cart system (cart), clearing house system (pay), afterSale system (afterSale), etc."),(0,i.kt)("h3",{id:"system-structure-analysis"},"System structure analysis"),(0,i.kt)("p",null,"In the mall system mentioned above, each system provides services to the outside world (http) while also providing data to other subsystems for data access interface (rpc), so each subsystem can be split into a service, and the outside world provides two ways to access the system api and rpc, so that\nThe above system has the following structure according to the directory structure to split:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},".\n\u251c\u2500\u2500 afterSale\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 cart\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 order\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 pay\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 product\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u2514\u2500\u2500 user\n    \u251c\u2500\u2500 api\n    \u2514\u2500\u2500 rpc\n")),(0,i.kt)("h3",{id:"rpc-call-chain-suggestions"},"rpc call chain suggestions"),(0,i.kt)("p",null,"When designing the system, try to make the call chain between services is one-way, rather than circular call, for example: order service calls user service, and user service in turn will call order's service.\nWhen one of the services start to fail, it will affect each other and enter a dead loop, you order that the failure of the user service, and user that the order service caused, if there are a large number of services exist in the chain of mutual invocation.\nThen you need to consider whether service splitting is reasonable."),(0,i.kt)("h3",{id:"directory-structure-of-common-service-types"},"Directory structure of common service types"),(0,i.kt)("p",null,"In the above services, only api/rpc services are listed, in addition, there may be more service types under one service, such as rmq (message processing system), cron (timed task system), script (script), etc.\nSo a service may contain the following directory structure."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"user\n    \u251c\u2500\u2500 api //  http access service, business requirements implementation\n    \u251c\u2500\u2500 cronjob // Timed tasks, timed data update operations\n    \u251c\u2500\u2500 rmq // Message processing system: mq and dq, dealing with some high concurrency and delayed message business\n    \u251c\u2500\u2500 rpc // rpc service, providing basic data access to other subsystems\n    \u2514\u2500\u2500 script // Scripts to handle some ad hoc operational requirements, ad hoc data fixes\n")),(0,i.kt)("h3",{id:"example-of-the-complete-project-directory-structure"},"Example of the complete project directory structure"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"mall // Project Name\n\u251c\u2500\u2500 common // Universal Library\n\u2502\xa0\xa0 \u251c\u2500\u2500 randx\n\u2502\xa0\xa0 \u2514\u2500\u2500 stringx\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u2514\u2500\u2500 service // Service Storage Directory\n    \u251c\u2500\u2500 afterSale\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 cart\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 order\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 pay\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 product\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u2514\u2500\u2500 user\n        \u251c\u2500\u2500 api\n        \u251c\u2500\u2500 cronjob\n        \u251c\u2500\u2500 model\n        \u251c\u2500\u2500 rmq\n        \u251c\u2500\u2500 rpc\n        \u2514\u2500\u2500 script\n")),(0,i.kt)("h2",{id:"model-generation"},"model generation"),(0,i.kt)("p",null,"First, after downloading the ",(0,i.kt)("a",{parentName:"p",href:"https://go-zero.dev/cn/resource/book.zip"},"demo project"),", we use the user's model for code generation demo."),(0,i.kt)("p",null,"The model is the bridge for the service to access the persistent data layer, the persistent data of the business often exists in mysql, mongo and other databases, and we all know that there is nothing better than CURD for a database operation.\nI once wrote 40 model files when writing a business, and depending on the complexity of the different business requirements, each model file takes on average almost\n10 minutes, for 40 files, 400 minutes of work time, almost a day's workload, and goctl tools can be completed in 10 seconds to complete the 400 minutes of work."),(0,i.kt)("h3",{id:"preparation"},"Preparation"),(0,i.kt)("p",null,"Go into the demo project book, find the user.sql file under user/model, and execute it in your own database to build the table."),(0,i.kt)("h3",{id:"code-generation-with-cache"},"Code generation (with cache)"),(0,i.kt)("h4",{id:"way-one-ddl"},"way one (ddl)"),(0,i.kt)("p",null,"Go to the ",(0,i.kt)("inlineCode",{parentName:"p"},"service/user/model")," directory and execute the command"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/model\n$ goctl model mysql ddl -src user.sql -dir . -c\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"Done.\n")),(0,i.kt)("h4",{id:"way-twodatasource"},"way two(datasource)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ goctl model mysql datasource -url="$datasource" -table="user" -c -dir .\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"Done.\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"$datasource is the database connection address"))),(0,i.kt)("h4",{id:"way-threeintellij-plugin"},"way three(intellij plugin)"),(0,i.kt)("p",null,"In Goland, right click on ",(0,i.kt)("inlineCode",{parentName:"p"},"user.sql"),", go to ",(0,i.kt)("inlineCode",{parentName:"p"},"New"),"->",(0,i.kt)("inlineCode",{parentName:"p"},"Go Zero"),"->",(0,i.kt)("inlineCode",{parentName:"p"},"Model Code")," to generate it, or open the ",(0,i.kt)("inlineCode",{parentName:"p"},"user.sql")," file.\nGo to the edit area, use the shortcut ",(0,i.kt)("inlineCode",{parentName:"p"},"Command+N")," (for mac OS) or ",(0,i.kt)("inlineCode",{parentName:"p"},"alt+insert")," (for windows) and select ",(0,i.kt)("inlineCode",{parentName:"p"},"Model Code"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://zeromicro.github.io/go-zero-pages/resource/intellij-model.png",alt:"model\u751f\u6210"})),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"intellij plugin generation requires the installation of the goctl plugin"))),(0,i.kt)("h3",{id:"validate-the-generated-model-file"},"Validate the generated model file"),(0,i.kt)("p",null,"tree"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ tree\uff0cClick to enter in order New->Go Zero->Api Code\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},".\n\u251c\u2500\u2500 user.sql\n\u251c\u2500\u2500 usermodel.go\n\u2514\u2500\u2500 vars.go\n")),(0,i.kt)("h2",{id:"api-file-writing"},"api file writing"),(0,i.kt)("h3",{id:"write-userapi-file"},"Write user.api file"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/user.api  \n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'type (\n    LoginReq {\n        Username string `json:"username"`\n        Password string `json:"password"`\n    }\n\n    LoginReply {\n        Id           int64 `json:"id"`\n        Name         string `json:"name"`\n        Gender       string `json:"gender"`\n        AccessToken  string `json:"accessToken"`\n        AccessExpire int64 `json:"accessExpire"`\n        RefreshAfter int64 `json:"refreshAfter"`\n    }\n)\n\nservice user-api {\n    @handler login\n    post /user/login (LoginReq) returns (LoginReply)\n}\n')),(0,i.kt)("h3",{id:"generate-api-service"},"Generate api service"),(0,i.kt)("h4",{id:"way-one"},"way one"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd book/service/user/api\n$ goctl api go -api user.api -dir . \n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"Done.\n")),(0,i.kt)("h4",{id:"way-two"},"way two"),(0,i.kt)("p",null,"Right click on the ",(0,i.kt)("inlineCode",{parentName:"p"},"user.api")," file, click ",(0,i.kt)("inlineCode",{parentName:"p"},"New"),"->",(0,i.kt)("inlineCode",{parentName:"p"},"Go Zero"),"->",(0,i.kt)("inlineCode",{parentName:"p"},"Api Code"),", enter the target directory, that is, the target directory of the api source code, the default is the directory where user.api is located, select the directory and click OK.\n",(0,i.kt)("img",{parentName:"p",src:"https://zeromicro.github.io/go-zero-pages/resource/goctl-api.png",alt:"api generation"}),"\n",(0,i.kt)("img",{parentName:"p",src:"https://zeromicro.github.io/go-zero-pages/resource/goctl-api-select.png",alt:"api generation directory selection"})),(0,i.kt)("h4",{id:"way-three"},"way three"),(0,i.kt)("p",null,"Open user.api, enter the editing area, use the shortcut ",(0,i.kt)("inlineCode",{parentName:"p"},"Command+N")," (for mac OS) or ",(0,i.kt)("inlineCode",{parentName:"p"},"alt+insert")," (for windows), select ",(0,i.kt)("inlineCode",{parentName:"p"},"Api Code"),", also enter the directory selection popup, select the directory and click OK."),(0,i.kt)("h2",{id:"business-coding"},"Business coding"),(0,i.kt)("p",null,"In the previous section, we have written user.api based on the initial requirements to describe what services the user service provides access to externally, in this section we continue where we left off.\nIn this section, we'll follow up on the previous steps and talk about how go-zero can be used in a real business through business coding."),(0,i.kt)("h3",{id:"adding-mysql-configuration"},"Adding Mysql configuration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/internal/config/config.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'package config\n\nimport "github.com/zeromicro/go-zero/rest"\n\ntype Config struct {\n    rest.RestConf\n    Mysql struct{\n        DataSource string\n    }\n    \n    CacheRedis cache.CacheConf\n}\n')),(0,i.kt)("h3",{id:"improve-yaml-configuration"},"Improve yaml configuration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/etc/user-api.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user-api\nHost: 0.0.0.0\nPort: 8888\nMysql:\n  DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n  - Host: $host\n    Pass: $pass\n    Type: node\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"$user: mysql database user"),(0,i.kt)("p",{parentName:"div"},"$password: mysql database password"),(0,i.kt)("p",{parentName:"div"},"$url: mysql database connection address"),(0,i.kt)("p",{parentName:"div"},"$db: mysql database db name, i.e. the database where the user table is located"),(0,i.kt)("p",{parentName:"div"},"$host: redis connection address Format: ip:port, e.g.:127.0.0.1:6379"),(0,i.kt)("p",{parentName:"div"},"$pass: redis password"))),(0,i.kt)("h3",{id:"perfect-service-dependence"},"Perfect service dependence"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/internal/svc/servicecontext.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config    config.Config\n    UserModel model.UserModel\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    conn:=sqlx.NewMysql(c.Mysql.DataSource)\n    return &ServiceContext{\n        Config: c,\n        UserModel: model.NewUserModel(conn,c.CacheRedis),\n    }\n}\n")),(0,i.kt)("h3",{id:"populate-login-logic"},"Populate login logic"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/internal/logic/loginlogic.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func (l *LoginLogic) Login(req types.LoginReq) (*types.LoginReply, error) {\n    if len(strings.TrimSpace(req.Username)) == 0 || len(strings.TrimSpace(req.Password)) == 0 {\n        return nil, errors.New("Parameter error")\n    }\n    \n    userInfo, err := l.svcCtx.UserModel.FindOneByNumber(req.Username)\n    switch err {\n    case nil:\n    case model.ErrNotFound:\n        return nil, errors.New("Username does not exist")\n    default:\n        return nil, err\n    }\n    \n    if userInfo.Password != req.Password {\n        return nil, errors.New("Incorrect user password")\n    }\n    \n    // ---start---\n    now := time.Now().Unix()\n    accessExpire := l.svcCtx.Config.Auth.AccessExpire\n    jwtToken, err := l.getJwtToken(l.svcCtx.Config.Auth.AccessSecret, now, l.svcCtx.Config.Auth.AccessExpire, userInfo.Id)\n    if err != nil {\n        return nil, err\n    }\n    // ---end---\n    \n    return &types.LoginReply{\n        Id:           userInfo.Id,\n        Name:         userInfo.Name,\n        Gender:       userInfo.Gender,\n        AccessToken:  jwtToken,\n        AccessExpire: now + accessExpire,\n        RefreshAfter: now + accessExpire/2,\n    }, nil\n}  \n')),(0,i.kt)("h2",{id:"jwt-forensics"},"jwt forensics"),(0,i.kt)("h3",{id:"overview"},"Overview"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and independent method for securely transferring information as JSON objects between parties. Since this information is digitally signed, it can be verified and trusted. A JWT can be signed using a secret (using the HMAC algorithm) or a public/private key pair using RSA or ECDSA.")),(0,i.kt)("h3",{id:"when-should-jwt-be-used"},"When should JWT be used"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Authorization: This is the most common scenario for using JWT. Once a user logs in, each subsequent request will include the JWT, thus allowing the user to access the routes, services and resources allowed by the token. Single sign-on is a feature that is widely used in JWT today because it has minimal overhead and can be easily used across domains.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Information Exchange: JSON Web tokens are a great way to securely transfer information between parties. Because the JWT can be signed (e.g., using a public/private key pair), you can be sure that the sender is who they say they are. In addition, because signatures are calculated using headers and payloads, you can also verify that the content has not been tampered with."))),(0,i.kt)("h3",{id:"why-use-json-web-tokens"},"Why use JSON Web tokens"),(0,i.kt)("p",null,"Because JSON is less verbose than XML, JSON is also smaller in size when encoded, making JWTs more compact than SAML. This makes JWT a good choice for passing in HTML and HTTP environments."),(0,i.kt)("p",null,"In terms of security, SWTs can only be symmetrically signed by shared secrets using the HMAC algorithm. However, JWT and SAML tokens can be signed using a public/private key pair in the form of an X.509 certificate. Signing XML using XML Digital Signature without introducing ambiguous security vulnerabilities is very difficult compared to the simplicity of signing JSON."),(0,i.kt)("p",null,"JSON parsers are common in most programming languages because they map directly to objects. In contrast, XML does not have a natural document-to-object mapping. This makes using JWT much easier than SAML assertions."),(0,i.kt)("p",null,"Regarding usage, JWT is used at Internet scale. This highlights the simplicity of client-side processing of JSON Web tokens on multiple platforms (especially mobile platforms)."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The above is all from ",(0,i.kt)("a",{parentName:"p",href:"https://jwt.io/introduction"},"jwt official website introduction")))),(0,i.kt)("h3",{id:"how-to-use-jwt-in-go-zero"},"How to use jwt in go-zero"),(0,i.kt)("p",null,"jwt authentication is generally used in the api layer, and in this demo project we generate jwt token when user api logs in and verify user jwt token when search api queries for books in two steps respectively."),(0,i.kt)("h4",{id:"user-api-generates-jwt-token"},"user api generates jwt token"),(0,i.kt)("p",null,"Moving on from the ",(0,i.kt)("a",{parentName:"p",href:"/en/docs/project/business"},"business coding")," section, we refine the ",(0,i.kt)("inlineCode",{parentName:"p"},"getJwtToken")," method left over from the previous section, i.e. the jwt token generation logic"),(0,i.kt)("h5",{id:"add-configuration-definition-and-yaml-configuration-items"},"Add configuration definition and yaml configuration items"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/internal/config/config.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    rest.RestConf\n    Mysql struct{\n        DataSource string\n    }\n    CacheRedis cache.CacheConf\n    Auth      struct {\n        AccessSecret string\n        AccessExpire int64\n    }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/etc/user-api.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user-api\nHost: 0.0.0.0\nPort: 8888\nMysql:\n  DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n  - Host: $host\n    Pass: $pass\n    Type: node\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"$AccessSecret: the key to generate the jwt token, the simplest way can use a uuid value."),(0,i.kt)("p",{parentName:"div"},"$AccessExpire: the validity of the jwt token, unit: second"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/internal/logic/loginlogic.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func (l *LoginLogic) getJwtToken(secretKey string, iat, seconds, userId int64) (string, error) {\n  claims := make(jwt.MapClaims)\n  claims["exp"] = iat + seconds\n  claims["iat"] = iat\n  claims["userId"] = userId\n  token := jwt.New(jwt.SigningMethodHS256)\n  token.Claims = claims\n  return token.SignedString([]byte(secretKey))\n}\n')),(0,i.kt)("h4",{id:"search-api-using-jwt-token-authentication"},"search api using jwt token authentication"),(0,i.kt)("h5",{id:"writing-searchapi-file"},"writing search.api file"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/search.api\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'type (\n    SearchReq {\n        Name string `form:"name"`\n    }\n\n    SearchReply {\n        Name string `json:"name"`\n        Count int `json:"count"`\n    }\n)\n\n@server(\n    jwt: Auth\n)\nservice search-api {\n    @handler search\n    get /search/do (SearchReq) returns (SearchReply)\n}\n\nservice search-api {\n    @handler ping\n    get /search/ping\n}\n')),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},(0,i.kt)("inlineCode",{parentName:"p"},"jwt: Auth"),"\uff1aEnabling jwt forensics"),(0,i.kt)("p",{parentName:"div"},"If the route requires jwt authentication, this syntax flag needs to be declared above the service, as in ",(0,i.kt)("inlineCode",{parentName:"p"}," /search/do")," above"),(0,i.kt)("p",{parentName:"div"},"Routes that do not require jwt authentication do not need to be declared, such as ",(0,i.kt)("inlineCode",{parentName:"p"}," /search/ping")," above"))),(0,i.kt)("h5",{id:"generating-code"},"Generating Code"),(0,i.kt)("p",null,"There are three ways to generate code as described earlier, so I won't go over them here."),(0,i.kt)("h5",{id:"add-yaml-configuration-items"},"Add yaml configuration items"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/etc/search-api.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: search-api\nHost: 0.0.0.0\nPort: 8889\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\n\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"$AccessSecret\uff1aThis value must be the same as the one declared in the user api."),(0,i.kt)("p",{parentName:"div"},"$AccessExpire: Expiration date"),(0,i.kt)("p",{parentName:"div"},"Change the port here to avoid conflict with user api port ",(0,i.kt)("inlineCode",{parentName:"p"},"8888")))),(0,i.kt)("h4",{id:"verify-jwt-token"},"verify jwt token"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Start user api service and login"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/api\n$ go run user.go -f etc/user-api.yaml\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"Starting server at 0.0.0.0:8888...\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl -i -X POST \\\n  http://127.0.0.1:8888/user/login \\\n  -H \'content-type: application/json\' \\\n  -d \'{\n    "username":"666",\n    "password":"123456"\n}\'\n')),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent-Type: application/json\nDate: Mon, 08 Feb 2021 10:37:54 GMT\nContent-Length: 251\n\n{"id":1,"name":"\u5c0f\u660e","gender":"\u7537","accessToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80","accessExpire":1612867074,"refreshAfter":1612823874}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Start the search api service and call ",(0,i.kt)("inlineCode",{parentName:"p"},"/search/do")," to verify that the jwt authentication passes"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ go run search.go -f etc/search-api.yaml\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"Starting server at 0.0.0.0:8889...\n")),(0,i.kt)("p",{parentName:"li"},"  Let's not pass the jwt token and see the result"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0'\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"HTTP/1.1 401 Unauthorized\nDate: Mon, 08 Feb 2021 10:41:57 GMT\nContent-Length: 0\n")),(0,i.kt)("p",{parentName:"li"},"Obviously, jwt authentication failed and returned 401 statusCode, next we bring the jwt token (i.e. the ",(0,i.kt)("inlineCode",{parentName:"p"},"accessToken")," returned by the user login)"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\\n  -H 'authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80'\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent-Type: application/json\nDate: Mon, 08 Feb 2021 10:44:45 GMT\nContent-Length: 21\n\n{"name":"","count":0}\n')))),(0,i.kt)("p",null,"At this point, the jwt demo is complete from generation to use. The authentication of the jwt token is already encapsulated inside go-zero, you just need to simply declare it when defining the service in the api file."),(0,i.kt)("h4",{id:"gets-the-information-carried-in-the-jwt-token"},"gets the information carried in the jwt token"),(0,i.kt)("p",null,"go-zero will parse the jwt token and put the kv passed in when the user generates the token in the Context of http."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/search/api/internal/logic/searchlogic.go\n")),(0,i.kt)("p",null,"Add a log to output the userId parsed from jwt."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) {\n    logx.Infof("userId: %v",l.ctx.Value("userId"))\n    return &types.SearchReply{}, nil\n}\n')),(0,i.kt)("p",null,"Running results"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'{"@timestamp":"2021-02-09T10:29:09.399+08","level":"info","content":"userId: 1"}\n')),(0,i.kt)("h2",{id:"middleware-usage"},"Middleware Usage"),(0,i.kt)("p",null,"In the previous section, we demonstrated how to use jwt forensics, I believe you have mastered the basic use of jwt, this section we look at how to use the api service middleware."),(0,i.kt)("h3",{id:"middleware-classification"},"Middleware classification"),(0,i.kt)("p",null,"In go-zero, middleware can be divided into routing middleware and global middleware, routing middleware refers to some specific routes need to implement middleware logic, its similar to jwt, no route placed under ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt:xxx")," will not use the middleware functionality.\nwhile the scope of the global middleware is the entire service."),(0,i.kt)("h3",{id:"middleware-usage-1"},"Middleware usage"),(0,i.kt)("p",null,"Here is an example of the ",(0,i.kt)("inlineCode",{parentName:"p"},"search")," service to demonstrate the use of middleware"),(0,i.kt)("h4",{id:"routing-middleware"},"routing middleware"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Rewrite the ",(0,i.kt)("inlineCode",{parentName:"p"},"search.api")," file and add the ",(0,i.kt)("inlineCode",{parentName:"p"},"middleware")," declaration"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/search/api\n$ vim search.api\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"type SearchReq struct {}\n\ntype SearchReply struct {}\n\n@server(\n    jwt: Auth\n    middleware: Example \n)\nservice search-api {\n    @handler search\n    get /search/do (SearchReq) returns (SearchReply)\n}\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Regenerate api code"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ goctl api go -api search.api -dir . \n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"etc/search-api.yaml exists, ignored generation\ninternal/config/config.go exists, ignored generation\nsearch.go exists, ignored generation\ninternal/svc/servicecontext.go exists, ignored generation\ninternal/handler/searchhandler.go exists, ignored generation\ninternal/handler/pinghandler.go exists, ignored generation\ninternal/logic/searchlogic.go exists, ignored generation\ninternal/logic/pinglogic.go exists, ignored generation\nDone.\n")),(0,i.kt)("p",{parentName:"li"},"  After generation, there will be one more ",(0,i.kt)("inlineCode",{parentName:"p"},"middleware")," directory in the ",(0,i.kt)("inlineCode",{parentName:"p"},"internal")," directory, where the middleware files are located and the subsequent middleware implementation logic is written here.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Improve the resource dependency ",(0,i.kt)("inlineCode",{parentName:"p"},"ServiceContext"),"."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/internal/svc/servicecontext.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config config.Config\n    Example rest.Middleware\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    return &ServiceContext{\n        Config: c,\n        Example: middleware.NewExampleMiddleware().Handle,\n    }\n}\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Writing middleware logic\nHere only add one line of log, content example middle, if the service is running output example middle means that the middleware is used up."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/internal/middleware/examplemiddleware.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'package middleware\n\nimport "net/http"\n\ntype ExampleMiddleware struct {\n}\n\nfunc NewExampleMiddleware() *ExampleMiddleware {\n        return &ExampleMiddleware{}\n}\n\nfunc (m *ExampleMiddleware) Handle(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        // TODO generate middleware implement function, delete after code implementation\n\n        // Passthrough to next handler if need\n        next(w, r)\n    }\n}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Start Service Verification"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},'{"@timestamp":"2021-02-09T11:32:57.931+08","level":"info","content":"example middle"}\n')))),(0,i.kt)("h4",{id:"global-middleware"},"Global Middleware"),(0,i.kt)("p",null,"Just use the Use method provided by rest.Server"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    flag.Parse()\n\n    var c config.Config\n    conf.MustLoad(*configFile, &c)\n\n    ctx := svc.NewServiceContext(c)\n    server := rest.MustNewServer(c.RestConf)\n    defer server.Stop()\n\n    server.Use(func(next http.HandlerFunc) http.HandlerFunc {\n        return func(w http.ResponseWriter, r *http.Request) {\n            logx.Info("global middleware")\n            next(w, r)\n        }\n    })\n    handler.RegisterHandlers(server, ctx)\n\n    fmt.Printf("Starting server at %s:%d...\\n", c.Host, c.Port)\n    server.Start()\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'{"@timestamp":"2021-02-09T11:50:15.388+08","level":"info","content":"global middleware"}\n')),(0,i.kt)("h4",{id:"calling-other-services-from-within-the-middleware"},"Calling other services from within the middleware"),(0,i.kt)("p",null,"Other services are passed to the middleware by means of closures, as in the following example."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'type AnotherService struct{}\n\nfunc (s *AnotherService) GetToken() string {\n    return stringx.Rand()\n}\n\nfunc middleware(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        w.Header().Add("X-Middleware", "static-middleware")\n        next(w, r)\n    }\n}\n\nfunc middlewareWithAnotherService(s *AnotherService) rest.Middleware {\n    return func(next http.HandlerFunc) http.HandlerFunc {\n        return func(w http.ResponseWriter, r *http.Request) {\n            w.Header().Add("X-Middleware", s.GetToken())\n            next(w, r)\n        }\n    }\n}\n')),(0,i.kt)("p",null,"Full code reference\uff1a",(0,i.kt)("a",{parentName:"p",href:"https://github.com/zeromicro/zero-examples/tree/main/http/middleware"},"https://github.com/zeromicro/zero-examples/tree/main/http/middleware")),(0,i.kt)("h2",{id:"rpc-writing-and-calling"},"rpc writing and calling"),(0,i.kt)("p",null,"In a large system, there is bound to be data transfer between multiple subsystems (services), and with data transfer there is a need for communication methods, you can choose the simplest http for communication, or you can choose rpc services for communication.\nAt go-zero, we use zrpc to communicate between services. zrpc is based on grpc."),(0,i.kt)("h3",{id:"scenarios"},"Scenarios"),(0,i.kt)("p",null,"We have perfected the interface protocols for user login and user query, but the user does not do any user verification when querying books, so if the current user is a non-existent user we do not allow him/her to access the book information.\nFrom the information above, we know that we need the user service to provide a method to get user information for the search service, so we need to create a user rpc service and provide a getUser method."),(0,i.kt)("h3",{id:"rpc-service-writing"},"rpc service writing"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Compile the proto file")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/rpc/user.proto\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage user;\n\noption go_package = "user";\n\nmessage IdReq{\n  int64 id = 1;\n}\n\nmessage UserInfoReply{\n  int64 id = 1;\n  string name = 2;\n  string number = 3;\n  string gender = 4;\n}\n\nservice user {\n  rpc getUser(IdReq) returns(UserInfoReply);\n}\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Generate rpc service code")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/rpc\n$ goctl rpc proto -src user.proto -dir .\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If the installed version of ",(0,i.kt)("inlineCode",{parentName:"p"},"protoc-gen-go")," is larger than 1.4.0, it is recommended to add ",(0,i.kt)("inlineCode",{parentName:"p"},"go_package")," to the proto file"))),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Add configuration and refine yaml configuration items")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/rpc/internal/config/config.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    zrpc.RpcServerConf\n    Mysql struct {\n        DataSource string\n    }\n    CacheRedis cache.CacheConf\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/user/rpc/etc/user.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user.rpc\nListenOn: 127.0.0.1:8080\nEtcd:\nHosts:\n- $etcdHost\n  Key: user.rpc\nMysql:\nDataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n- Host: $host\n  Pass: $pass\n  Type: node  \n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"$user: mysql database user"),(0,i.kt)("p",{parentName:"div"},"$password: mysql database password"),(0,i.kt)("p",{parentName:"div"},"$url: mysql database connection address"),(0,i.kt)("p",{parentName:"div"},"$db: mysql database db name, i.e. the database where the user table is located"),(0,i.kt)("p",{parentName:"div"},"$host: redis connection address Format: ip:port, e.g.:127.0.0.1:6379"),(0,i.kt)("p",{parentName:"div"},"$pass: redis password"),(0,i.kt)("p",{parentName:"div"},"$etcdHost: etcd connection address, format: ip:port, e.g.: 127.0.0.1:2379"))),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Adding Resource Dependencies",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/rpc/internal/svc/servicecontext.go  \n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config    config.Config\n    UserModel model.UserModel\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    conn := sqlx.NewMysql(c.Mysql.DataSource)\n    return &ServiceContext{\n        Config: c,\n        UserModel: model.NewUserModel(conn, c.CacheRedis),\n    }\n}\n"))),(0,i.kt)("li",{parentName:"ul"},"Adding rpc logic",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ service/user/rpc/internal/logic/getuserlogic.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},"func (l *GetUserLogic) GetUser(in *user.IdReq) (*user.UserInfoReply, error) {\n    one, err := l.svcCtx.UserModel.FindOne(in.Id)\n    if err != nil {\n        return nil, err\n    }\n    \n    return &user.UserInfoReply{\n        Id:     one.Id,\n        Name:   one.Name,\n        Number: one.Number,\n        Gender: one.Gender,\n    }, nil\n}\n")))),(0,i.kt)("h3",{id:"using-rpc"},"Using rpc"),(0,i.kt)("p",null,"Next we call user rpc in the search service"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Add UserRpc configuration and yaml configuration items")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/internal/config/config.go\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    rest.RestConf\n    Auth struct {\n        AccessSecret string\n        AccessExpire int64\n    }\n    UserRpc zrpc.RpcClientConf\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/etc/search-api.yaml\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: search-api\nHost: 0.0.0.0\nPort: 8889\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\nUserRpc:\n  Etcd:\n    Hosts:\n      - $etcdHost\n    Key: user.rpc\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"$AccessSecret: This value must be the same as the one declared in the user api."),(0,i.kt)("p",{parentName:"div"},"$AccessExpire: expiration date"),(0,i.kt)("p",{parentName:"div"},"$etcdHost: etcd connection address"),(0,i.kt)("p",{parentName:"div"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Key")," in etcd must be the same as the Key in the user rpc service configuration"))),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Adding dependencies",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/internal/svc/servicecontext.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config  config.Config\n    Example rest.Middleware\n    UserRpc userclient.User\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    return &ServiceContext{\n        Config:  c,\n        Example: middleware.NewExampleMiddleware().Handle,\n        UserRpc: userclient.NewUser(zrpc.MustNewClient(c.UserRpc)),\n    }\n}\n"))),(0,i.kt)("li",{parentName:"ul"},"Additional logic",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/search/api/internal/logic/searchlogic.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) {\n    userIdNumber := json.Number(fmt.Sprintf("%v", l.ctx.Value("userId")))\n    logx.Infof("userId: %s", userIdNumber)\n    userId, err := userIdNumber.Int64()\n    if err != nil {\n        return nil, err\n    }\n    \n    _, err = l.svcCtx.UserRpc.GetUser(l.ctx, &userclient.IdReq{\n        Id: userId,\n    })\n    if err != nil {\n        return nil, err\n    }\n\n    return &types.SearchReply{\n        Name:  req.Name,\n        Count: 100,\n    }, nil\n}\n')))),(0,i.kt)("h3",{id:"start-and-verify-services"},"Start and verify services"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Start etcd, redis, mysql"),(0,i.kt)("li",{parentName:"ul"},"Start user rpc",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd /service/user/rpc\n$ go run user.go -f etc/user.yaml\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"Starting rpc server at 127.0.0.1:8080...\n"))),(0,i.kt)("li",{parentName:"ul"},"start search api")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/search/api\n$ go run search.go -f etc/search-api.yaml\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Validation Services",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\\n  -H 'authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80'\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent\n-Type: application/json\nDate: Tue, 09 Feb 2021 06:05:52 GMT\nContent-Length: 32\n\n{"name":"\u897f\u6e38\u8bb0","count":100}\n')))),(0,i.kt)("h2",{id:"error-handling"},"Error Handling"),(0,i.kt)("p",null,"Error handling is an indispensable part of a service. In normal business development, we can consider any http status code not in the ",(0,i.kt)("inlineCode",{parentName:"p"},"2xx")," series to be an http request error, along with a response error message.\nand accompanied by the response error message, but these error messages are returned in the form of plain text. In addition, I also define some business errors in the business, and the common practice is to use the\n",(0,i.kt)("inlineCode",{parentName:"p"},"code"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"msg")," fields to describe the results of business processing, and would like to be able to respond in a json response body."),(0,i.kt)("h3",{id:"business-error-response-format"},"Business error response format"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Business processing is normal"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "code": 0,\n  "msg": "successful",\n  "data": {\n    ....\n  }\n}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Business Processing Exceptions"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "code": 10001,\n  "msg": "Parameter error"\n}\n')),(0,i.kt)("h3",{id:"user-api-login"},"user api login"),(0,i.kt)("p",null,"Previously, when we handled a non-existent username in the login logic, an error was returned directly, so let's login and pass a non-existent username to see the effect."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X POST \\\n  http://127.0.0.1:8888/user/login \\\n  -H \'content-type: application/json\' \\\n  -d \'{\n    "username":"1",\n    "password":"123456"\n}\'\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"HTTP/1.1 400 Bad Request\nContent-Type: text/plain; charset=utf-8\nX-Content-Type-Options: nosniff\nDate: Tue, 09 Feb 2021 06:38:42 GMT\nContent-Length: 19\n\nUsername does not exist\n")),(0,i.kt)("p",null,"Next, we return it in json format"),(0,i.kt)("h3",{id:"custom-errors"},"Custom errors"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"First add a ",(0,i.kt)("inlineCode",{parentName:"p"},"baseerror.go")," file to the common and fill in the code"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd common\n$ mkdir errorx&&cd errorx\n$ vim baseerror.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-goalng"},'package errorx\n\nconst defaultCode = 1001\n\ntype CodeError struct {\n    Code int    `json:"code"`\n    Msg  string `json:"msg"`\n}\n\ntype CodeErrorResponse struct {\n    Code int    `json:"code"`\n    Msg  string `json:"msg"`\n}\n\nfunc NewCodeError(code int, msg string) error {\n    return &CodeError{Code: code, Msg: msg}\n}\n\nfunc NewDefaultError(msg string) error {\n    return NewCodeError(defaultCode, msg)\n}\n\nfunc (e *CodeError) Error() string {\n    return e.Msg\n}\n\nfunc (e *CodeError) Data() *CodeErrorResponse {\n    return &CodeErrorResponse{\n        Code: e.Code,\n        Msg:  e.Msg,\n    }\n}\n\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Replace errors in the login logic with CodeError custom errors"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'if len(strings.TrimSpace(req.Username)) == 0 || len(strings.TrimSpace(req.Password)) == 0 {\n        return nil, errorx.NewDefaultError("xxx")\n    }\n\n    userInfo, err := l.svcCtx.UserModel.FindOneByNumber(req.Username)\n    switch err {\n    case nil:\n    case model.ErrNotFound:\n        return nil, errorx.NewDefaultError("xxx")\n    default:\n        return nil, err\n    }\n\n    if userInfo.Password != req.Password {\n        return nil, errorx.NewDefaultError("xxx")\n    }\n\n    now := time.Now().Unix()\n    accessExpire := l.svcCtx.Config.Auth.AccessExpire\n    jwtToken, err := l.getJwtToken(l.svcCtx.Config.Auth.AccessSecret, now, l.svcCtx.Config.Auth.AccessExpire, userInfo.Id)\n    if err != nil {\n        return nil, err\n    }\n\n    return &types.LoginReply{\n        Id:           userInfo.Id,\n        Name:         userInfo.Name,\n        Gender:       userInfo.Gender,\n        AccessToken:  jwtToken,\n        AccessExpire: now + accessExpire,\n        RefreshAfter: now + accessExpire/2,\n    }, nil\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Turn on custom errors"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/api/user.go\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    flag.Parse()\n\n    var c config.Config\n    conf.MustLoad(*configFile, &c)\n\n    ctx := svc.NewServiceContext(c)\n    server := rest.MustNewServer(c.RestConf)\n    defer server.Stop()\n\n    handler.RegisterHandlers(server, ctx)\n\n    httpx.SetErrorHandler(func(err error) (int, interface{}) {\n        switch e := err.(type) {\n        case *errorx.CodeError:\n            return http.StatusOK, e.Data()\n        default:\n            return http.StatusInternalServerError, nil\n        }\n    })\n\n    fmt.Printf("Starting server at %s:%d...\\n", c.Host, c.Port)\n    server.Start()\n}\n'))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Restart service verification"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl -i -X POST \\\n  http://127.0.0.1:8888/user/login \\\n  -H \'content-type: application/json\' \\\n  -d \'{\n        "username":"1",\n        "password":"123456"\n}\'\n')),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent-Type: application/json\nDate: Tue, 09 Feb 2021 06:47:29 GMT\nContent-Length: 40\n\n{"code":1001,"msg":"Username does not exist"}\n')))))}m.isMDXComponent=!0}}]);