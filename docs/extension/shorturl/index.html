<!doctype html>
<html class="docs-version-current" lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="go-zero RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="go-zero Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="go-zero" href="/opensearch.xml"><title data-react-helmet="true">快速构建高并发微服务 | go-zero</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeromicro.github.io/docs/extension/shorturl"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="快速构建高并发微服务 | go-zero"><meta data-react-helmet="true" name="description" content="为什么说做好微服务很难"><meta data-react-helmet="true" property="og:description" content="为什么说做好微服务很难"><link data-react-helmet="true" rel="icon" href="/img/go-zero.svg"><link data-react-helmet="true" rel="canonical" href="https://zeromicro.github.io/docs/extension/shorturl"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/docs/extension/shorturl" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/en/docs/extension/shorturl" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/docs/extension/shorturl" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ebdda6f7.css">
<link rel="preload" href="/assets/js/runtime~main.f1cb22ad.js" as="script">
<link rel="preload" href="/assets/js/main.9a22f610.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Go-zero</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro/brief">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/docs/extension/shorturl" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文</a></li><li><a href="/en/docs/extension/shorturl" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro/brief">简介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/quick-start/concept">快速开始</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/build-tool/tool-intro">构建工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/component/rest">框架组件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/other-component/go-queue">其他组件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/project/prepare">项目开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/ecology/intellij">框架生态</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/extension/shorturl">扩展阅读</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/extension/shorturl">快速构建高并发微服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/logx">日志组件介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/bloom">布隆过滤器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/executors">executors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/fx">数据流处理组件 fx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/mysql">go-zero mysql使用介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/redis-lock">redis锁</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/periodlimit">periodlimit限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/tokenlimit">令牌桶限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/timing-wheel">时间轮介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/collection">进程内缓存组件 collection.Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/keywords">高效的关键词替换和敏感词过滤工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/mapping">文本序列化和反序列化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/mapreduce">并发处理工具 MapReduce</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/metric">基于prometheus的微服务指标监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/sharedcalls">防止缓存击穿之进程内共享调用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/sql-cache">DB缓存机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/zrpc">zRPC使用介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/redis-cache">go-zero缓存设计之持久层缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/buiness-cache">go-zero缓存设计之业务层缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/go-queue">go-zero 分布式定时任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/go-zero-looklook">使用go-zero开发一个旅游系统go-zero-looklook</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/datacenter">go-zero 实现一个中台系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/stream">流数据处理利器</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/problem/in-use">问题汇总</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>快速构建高并发微服务</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="为什么说做好微服务很难">为什么说做好微服务很难<a class="hash-link" href="#为什么说做好微服务很难" title="Direct link to heading">​</a></h2><p>要想做好微服务，我们需要理解和掌握的知识点非常多，从几个维度上来说：</p><ul><li><p>基本功能层面</p><ol><li>并发控制 &amp; 限流，避免服务被突发流量击垮</li><li>服务注册与服务发现，确保能够动态侦测增减的节点</li><li>负载均衡，需要根据节点承受能力分发流量</li><li>超时控制，避免对已超时请求做无用功</li><li>熔断设计，快速失败，保障故障节点的恢复能力</li></ol></li><li><p>高阶功能层面</p><ol><li>请求认证，确保每个用户只能访问自己的数据</li><li>链路追踪，用于理解整个系统和快速定位特定请求的问题</li><li>日志，用于数据收集和问题定位</li><li>可观测性，没有度量就没有优化</li></ol></li></ul><p>对于其中每一点，我们都需要用很长的篇幅来讲述其原理和实现，那么对我们后端开发者来说，要想把这些知识点都掌握并落实到业务系统里，难度是非常大的，不过我们可以依赖已经被大流量验证过的框架体系。<a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer">go-zero 微服务框架</a>就是为此而生。</p><p>另外，我们始终秉承 <strong>工具大于约定和文档</strong> 的理念。我们希望尽可能减少开发人员的心智负担，把精力都投入到产生业务价值的代码上，减少重复代码的编写，所以我们开发了 <code>goctl</code> 工具。</p><p>下面我通过短链微服务来演示通过 <a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer">go-zero</a> 快速的创建微服务的流程，走完一遍，你就会发现：原来编写微服务如此简单！</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="什么是短链服务">什么是短链服务<a class="hash-link" href="#什么是短链服务" title="Direct link to heading">​</a></h2><p>短链服务就是将长的 URL 网址，通过程序计算等方式，转换为简短的网址字符串。</p><p>写此短链服务是为了从整体上演示 go-zero 构建完整微服务的过程，算法和实现细节尽可能简化了，所以这不是一个高阶的短链服务。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="短链微服务架构图">短链微服务架构图<a class="hash-link" href="#短链微服务架构图" title="Direct link to heading">​</a></h2><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-arch.png" alt="架构图" width="800"><ul><li>这里只用了 <code>Transform RPC</code> 一个微服务，并不是说 API Gateway 只能调用一个微服务，只是为了最简演示 API Gateway 如何调用 RPC 微服务而已</li><li>在真正项目里要尽可能每个微服务使用自己的数据库，数据边界要清晰</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="goctl-各层代码生成一览">goctl 各层代码生成一览<a class="hash-link" href="#goctl-各层代码生成一览" title="Direct link to heading">​</a></h2><p>所有绿色背景的功能模块是自动生成的，按需激活，红色模块是需要自己写的，也就是增加下依赖，编写业务特有逻辑，各层示意图分别如下：</p><ul><li><p>API Gateway</p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-api.png" alt="api" width="800"></li><li><p>RPC</p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-rpc.png" alt="架构图" width="800"></li><li><p>model</p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-model.png" alt="model" width="800"></li></ul><p>下面我们来一起完整走一遍快速构建微服务的流程，Let’s <code>Go</code>!🏃‍♂️</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="准备工作">准备工作<a class="hash-link" href="#准备工作" title="Direct link to heading">​</a></h2><ul><li><p>安装 etcd, mysql, redis</p></li><li><p>安装 <code>protoc-gen-go</code></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>安装 <code>protoc</code></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/protocolbuffers/protobuf/releases/download/v3.14.0/protoc-3.14.0-linux-x86_64.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">unzip</span><span class="token plain"> protoc-3.14.0-linux-x86_64.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> bin/protoc /usr/local/bin/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>安装 goctl 工具</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">GO111MODULE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">on </span><span class="token assign-left variable" style="color:#36acaa">GOPROXY</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://goproxy.cn/,direct go get -u github.com/zeromicro/go-zero/tools/goctl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>创建工作目录 <code>shorturl</code> 和 <code>shorturl/api</code></p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p shorturl/api</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>在 <code>shorturl</code> 目录下执行 <code>go mod init shorturl</code> 初始化 <code>go.mod</code></p><div class="codeBlockContainer_J+bg language-Plain theme-code-block"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">module shorturl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go 1.15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">require (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com/golang/mock v1.4.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com/golang/protobuf v1.4.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com/zeromicro/go-zero v1.1.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  golang.org/x/net v0.0.0-20200707034311-ab3426394381</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google.golang.org/grpc v1.29.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>注意：这里可能存在 grpc 版本依赖的问题，可以用以上配置</strong></p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="编写-api-gateway-代码">编写 API Gateway 代码<a class="hash-link" href="#编写-api-gateway-代码" title="Direct link to heading">​</a></h2><ul><li><p>在 <code>shorturl/api</code> 目录下通过 goctl 生成 <code>api/shorturl.api</code>：</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">goctl api -o shorturl.api</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>编辑 <code>api/shorturl.api</code>，为了简洁，去除了文件开头的 <code>info</code>，代码如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expandReq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shorten </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`form:&quot;shorten&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expandResp </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;url&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shortenReq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`form:&quot;url&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  shortenResp </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shorten </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:&quot;shorten&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service shorturl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">api </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @</span><span class="token function" style="color:#d73a49">server</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ShortenHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get </span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">shorten</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shortenReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">returns</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shortenResp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @</span><span class="token function" style="color:#d73a49">server</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ExpandHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get </span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expandReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">returns</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expandResp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>type 用法和 go 一致，service 用来定义 get/post/head/delete 等 api 请求，解释如下：</p><ul><li><code>service shorturl-api {</code> 这一行定义了 service 名字</li><li><code>@server</code> 部分用来定义 server 端用到的属性</li><li><code>handler</code> 定义了服务端 handler 名字</li><li><code>get /shorten(shortenReq) returns(shortenResp)</code> 定义了 get 方法的路由、请求参数、返回参数等</li></ul></li><li><p>使用 goctl 生成 API Gateway 代码</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">goctl api go -api shorturl.api -dir </span><span class="token builtin class-name">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>生成的文件结构如下：</p><div class="codeBlockContainer_J+bg language-Plain theme-code-block"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── shorturl-api.yaml         // 配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── config.go             // 定义配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── expandhandler.go      // 实现 expandHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── routes.go             // 定义路由处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── shortenhandler.go     // 实现 shortenHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── expandlogic.go        // 实现 ExpandLogic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── shortenlogic.go       // 实现 ShortenLogic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── servicecontext.go     // 定义 ServiceContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       └── types.go              // 定义请求、返回结构体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── shorturl.api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── shorturl.go                   // main 入口定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── go.mod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── go.sum</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>启动 API Gateway 服务，默认侦听在 8888 端口</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">go run shorturl.go -f etc/shorturl-api.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>测试 API Gateway 服务</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&quot;http://localhost:8888/shorten?url=http://www.xiaoheiban.cn&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>返回如下：</p><div class="codeBlockContainer_J+bg language-http theme-code-block"><div class="codeBlockContent_csEI http"><pre tabindex="0" class="prism-code language-http codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: Thu, 27 Aug 2020 14:31:39 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;shorten&quot;:&quot;&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可以看到我们 API Gateway 其实啥也没干，就返回了个空值，接下来我们会在 rpc 服务里实现业务逻辑</p></li><li><p>可以修改 <code>internal/svc/servicecontext.go</code> 来传递服务依赖（如果需要）</p></li><li><p>实现逻辑可以修改 <code>internal/logic</code> 下的对应文件</p></li><li><p>可以通过 <code>goctl</code> 生成各种客户端语言的 api 调用代码</p></li><li><p>到这里，你已经可以通过 goctl 生成客户端代码给客户端同学并行开发了，支持多种语言，详见文档</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="编写-transform-rpc-服务">编写 transform rpc 服务<a class="hash-link" href="#编写-transform-rpc-服务" title="Direct link to heading">​</a></h2><ul><li>在 <code>shorturl</code> 目录下创建 <code>rpc</code> 目录</li></ul><ul><li><p>在 <code>rpc/transform</code> 目录下编写 <code>transform.proto</code> 文件</p><p>可以通过命令生成 proto 文件模板</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">goctl rpc template -o transform.proto</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>修改后文件内容如下：</p><div class="codeBlockContainer_J+bg language-protobuf theme-code-block"><div class="codeBlockContent_csEI protobuf"><pre tabindex="0" class="prism-code language-protobuf codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package transform;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message expandReq {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string shorten = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message expandResp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string url = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message shortenReq {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string url = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message shortenResp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string shorten = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service transformer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpc expand(expandReq) returns(expandResp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpc shorten(shortenReq) returns(shortenResp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>用 <code>goctl</code> 生成 rpc 代码，在 <code>rpc/transform</code> 目录下执行命令</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">goctl rpc proto -src transform.proto -dir </span><span class="token builtin class-name">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>注意：不能在 GOPATH 目录下执行以上命令</strong></p><p>文件结构如下：</p><div class="codeBlockContainer_J+bg language-Plain theme-code-block"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">rpc/transform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── transform.yaml              // 配置文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── config.go               // 配置定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── expandlogic.go          // expand 业务逻辑在这里实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── shortenlogic.go         // shorten 业务逻辑在这里实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── transformerserver.go    // 调用入口, 不需要修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── servicecontext.go       // 定义 ServiceContext，传递依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── pb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── transform.pb.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── transform.go                    // rpc 服务 main 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── transform.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── transformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── transformer.go              // 提供了外部调用方法，无需修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── transformer_mock.go         // mock 方法，测试用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── types.go                    // request/response 结构体定义</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>直接可以运行，如下：</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$ go run transform.go -f etc/transform.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting rpc server at </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:8080</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>查看服务是否注册</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$ETCDCTL_API=3 etcdctl get transform.rpc --prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transform.rpc/7587851893787585061</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1:8080</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>etc/transform.yaml</code> 文件里可以修改侦听端口等配置</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="修改-api-gateway-代码调用-transform-rpc-服务">修改 API Gateway 代码调用 transform rpc 服务<a class="hash-link" href="#修改-api-gateway-代码调用-transform-rpc-服务" title="Direct link to heading">​</a></h2><ul><li><p>修改配置文件 <code>shorturl-api.yaml</code>，增加如下内容</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Transform</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> transform.rpc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过 etcd 自动去发现可用的 transform 服务</p></li><li><p>修改 <code>internal/config/config.go</code> 如下，增加 transform 服务依赖</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RestConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transform zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcClientConf     </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>修改 <code>internal/svc/servicecontext.go</code>，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ServiceContext </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Config    config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transformer transformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transformer                                          </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewServiceContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServiceContext </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Transformer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> transformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTransformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MustNewClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过 ServiceContext 在不同业务逻辑之间传递依赖</p></li><li><p>修改 <code>internal/logic/expandlogic.go</code> 里的 <code>Expand</code> 方法，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ExpandLogic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码开始</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">transformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandReq</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Shorten</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Shorten</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码结束</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><p>通过调用 <code>transformer</code> 的 <code>Expand</code> 方法实现短链恢复到 url</p><ul><li><p>修改 <code>internal/logic/shortenlogic.go</code>，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ShortenLogic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Shorten</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码开始</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Shorten</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">transformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenReq</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Shorten</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Shorten</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码结束</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>有的版本生成返回值可能是指针类型，需要自己调整下</p></li></ul><p>通过调用 <code>transformer</code> 的 <code>Shorten</code> 方法实现 url 到短链的变换</p><p>至此，API Gateway 修改完成，虽然贴的代码多，但是其中修改的是很少的一部分，为了方便理解上下文，我贴了完整代码，接下来处理 CRUD+cache</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="定义数据库表结构并生成-crudcache-代码">定义数据库表结构，并生成 CRUD+cache 代码<a class="hash-link" href="#定义数据库表结构并生成-crudcache-代码" title="Direct link to heading">​</a></h2><ul><li><p>shorturl 下创建 <code>rpc/transform/model</code> 目录：<code>mkdir -p rpc/transform/model</code></p></li><li><p>在 <code>rpc/transform/model</code> 目录下编写创建 shorturl 表的 sql 文件 <code>shorturl.sql</code>，如下：</p><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">shorturl</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">shorten</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;shorten key&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;original url&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">shorten</span><span class="token punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8mb4</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>创建 DB 和 table</p><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">database</span><span class="token plain"> gozero</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">source shorturl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">sql</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>在 <code>rpc/transform/model</code> 目录下执行如下命令生成 CRUD+cache 代码，<code>-c</code> 表示使用 <code>redis cache</code></p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">goctl model mysql ddl -c -src shorturl.sql -dir </span><span class="token builtin class-name">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>也可以用 <code>datasource</code> 命令代替 <code>ddl</code> 来指定数据库链接直接从 schema 生成</p><p>生成后的文件结构如下：</p><div class="codeBlockContainer_J+bg language-Plain theme-code-block"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">rpc/transform/model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── shorturl.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── shorturlmodel.go              // CRUD+cache 代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── vars.go                       // 定义常量和变量</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="修改-shortenexpand-rpc-代码调用-crudcache-代码">修改 shorten/expand rpc 代码调用 crud+cache 代码<a class="hash-link" href="#修改-shortenexpand-rpc-代码调用-crudcache-代码" title="Direct link to heading">​</a></h2><ul><li><p>修改 <code>rpc/transform/etc/transform.yaml</code>，增加如下内容：</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">DataSource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">password@tcp(localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3306)/gozero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Table</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shorturl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Cache</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6379</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可以使用多个 redis 作为 cache，支持 redis 单点或者 redis 集群</p></li><li><p>修改 <code>rpc/transform/internal/config/config.go</code>，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcServerConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DataSource </span><span class="token builtin">string</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Table      </span><span class="token builtin">string</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Cache      cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheConf    </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>增加了 mysql 和 redis cache 配置</p></li><li><p>修改 <code>rpc/transform/internal/svc/servicecontext.go</code>，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ServiceContext </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  c     config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Model model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShorturlModel   </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewServiceContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServiceContext </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">             c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Model</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewShorturlModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sqlx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewMysql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cache</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>修改 <code>rpc/transform/internal/logic/expandlogic.go</code>，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ExpandLogic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码开始</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FindOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Shorten</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码结束</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>修改 <code>rpc/transform/internal/logic/shortenlogic.go</code>，如下：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ShortenLogic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Shorten</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码开始，生成短链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Md5Hex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Shorturl</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Shorten</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Shorten</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 手动代码结束</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>至此代码修改完成，凡是手动修改的代码我加了标注</p><p><strong>注意：</strong></p><ol><li>undefined cache，你需要 <code>import &quot;github.com/zeromicro/go-zero/core/stores/cache&quot;</code></li><li>undefined model, sqlx, hash 等，你需要在文件中</li></ol><div class="codeBlockContainer_J+bg language-golang theme-code-block"><div class="codeBlockContent_csEI golang"><pre tabindex="0" class="prism-code language-golang codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;shorturl/rpc/transform/model&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;github.com/zeromicro/go-zero/core/stores/sqlx&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="完整调用演示">完整调用演示<a class="hash-link" href="#完整调用演示" title="Direct link to heading">​</a></h2><ul><li><p>shorten api 调用</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&quot;http://localhost:8888/shorten?url=http://www.xiaoheiban.cn&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>返回如下：</p><div class="codeBlockContainer_J+bg language-http theme-code-block"><div class="codeBlockContent_csEI http"><pre tabindex="0" class="prism-code language-http codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: Sat, 29 Aug 2020 10:49:49 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;shorten&quot;:&quot;f35b2a&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>expand api 调用</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&quot;http://localhost:8888/expand?shorten=f35b2a&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>返回如下：</p><div class="codeBlockContainer_J+bg language-http theme-code-block"><div class="codeBlockContent_csEI http"><pre tabindex="0" class="prism-code language-http codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: Sat, 29 Aug 2020 10:51:53 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;url&quot;:&quot;http://www.xiaoheiban.cn&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="benchmark">Benchmark<a class="hash-link" href="#benchmark" title="Direct link to heading">​</a></h2><p>因为写入依赖于 mysql 的写入速度，就相当于压 mysql 了，所以压测只测试了 expand 接口，相当于从 mysql 里读取并利用缓存，shorten.lua 里随机从 db 里获取了 100 个热 key 来生成压测请求</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-benchmark.png" alt="Benchmark"></p><p>可以看出在我的 MacBook Pro 上能达到 3 万 + 的 qps。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="完整代码">完整代码<a class="hash-link" href="#完整代码" title="Direct link to heading">​</a></h2><p><a href="https://github.com/zeromicro/zero-examples/tree/main/shorturl" target="_blank" rel="noopener noreferrer">https://github.com/zeromicro/zero-examples/tree/main/shorturl</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><p>我们一直强调 <strong>工具大于约定和文档</strong>。</p><p>go-zero 不只是一个框架，更是一个建立在框架 + 工具基础上的，简化和规范了整个微服务构建的技术体系。</p><p>我们在保持简单的同时也尽可能把微服务治理的复杂度封装到了框架内部，极大的降低了开发人员的心智负担，使得业务开发得以快速推进。</p><p>通过 go-zero+goctl 生成的代码，包含了微服务治理的各种组件，包括：并发控制、自适应熔断、自适应降载、自动缓存控制等，可以轻松部署以承载巨大访问量。</p><p>有任何好的提升工程效率的想法，随时欢迎交流！👏</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zeromicro/zero-doc/tree/main/website/docs/extension/shorturl.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ecology/distributed-transaction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">分布式事务支持</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/extension/logx"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">日志组件介绍</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#为什么说做好微服务很难" class="table-of-contents__link toc-highlight">为什么说做好微服务很难</a></li><li><a href="#什么是短链服务" class="table-of-contents__link toc-highlight">什么是短链服务</a></li><li><a href="#短链微服务架构图" class="table-of-contents__link toc-highlight">短链微服务架构图</a></li><li><a href="#goctl-各层代码生成一览" class="table-of-contents__link toc-highlight">goctl 各层代码生成一览</a></li><li><a href="#准备工作" class="table-of-contents__link toc-highlight">准备工作</a></li><li><a href="#编写-api-gateway-代码" class="table-of-contents__link toc-highlight">编写 API Gateway 代码</a></li><li><a href="#编写-transform-rpc-服务" class="table-of-contents__link toc-highlight">编写 transform rpc 服务</a></li><li><a href="#修改-api-gateway-代码调用-transform-rpc-服务" class="table-of-contents__link toc-highlight">修改 API Gateway 代码调用 transform rpc 服务</a></li><li><a href="#定义数据库表结构并生成-crudcache-代码" class="table-of-contents__link toc-highlight">定义数据库表结构，并生成 CRUD+cache 代码</a></li><li><a href="#修改-shortenexpand-rpc-代码调用-crudcache-代码" class="table-of-contents__link toc-highlight">修改 shorten/expand rpc 代码调用 crud+cache 代码</a></li><li><a href="#完整调用演示" class="table-of-contents__link toc-highlight">完整调用演示</a></li><li><a href="#benchmark" class="table-of-contents__link toc-highlight">Benchmark</a></li><li><a href="#完整代码" class="table-of-contents__link toc-highlight">完整代码</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro/brief">docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/go-zero/shared_invite/zt-10ruju779-BE4y6lQNB_R21samtyKTgA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Chat Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 go-zero.dev, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f1cb22ad.js"></script>
<script src="/assets/js/main.9a22f610.js"></script>
</body>
</html>