<!doctype html>
<html class="docs-version-current" lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="go-zero RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="go-zero Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="go-zero" href="/opensearch.xml"><title data-react-helmet="true">go-zero 实现一个中台系统 | go-zero</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeromicro.github.io/docs/extension/datacenter"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="go-zero 实现一个中台系统 | go-zero"><meta data-react-helmet="true" name="description" content="作者：Jack Luo"><meta data-react-helmet="true" property="og:description" content="作者：Jack Luo"><link data-react-helmet="true" rel="icon" href="/img/go-zero.svg"><link data-react-helmet="true" rel="canonical" href="https://zeromicro.github.io/docs/extension/datacenter"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/docs/extension/datacenter" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/en/docs/extension/datacenter" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/docs/extension/datacenter" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ebdda6f7.css">
<link rel="preload" href="/assets/js/runtime~main.f1cb22ad.js" as="script">
<link rel="preload" href="/assets/js/main.9a22f610.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Go-zero</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro/brief">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/docs/extension/datacenter" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文</a></li><li><a href="/en/docs/extension/datacenter" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro/brief">简介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/quick-start/concept">快速开始</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/build-tool/tool-intro">构建工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/component/rest">框架组件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/other-component/go-queue">其他组件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/project/prepare">项目开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/ecology/intellij">框架生态</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/extension/shorturl">扩展阅读</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/shorturl">快速构建高并发微服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/logx">日志组件介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/bloom">布隆过滤器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/executors">executors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/fx">数据流处理组件 fx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/mysql">go-zero mysql使用介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/redis-lock">redis锁</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/periodlimit">periodlimit限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/tokenlimit">令牌桶限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/timing-wheel">时间轮介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/collection">进程内缓存组件 collection.Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/keywords">高效的关键词替换和敏感词过滤工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/mapping">文本序列化和反序列化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/mapreduce">并发处理工具 MapReduce</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/metric">基于prometheus的微服务指标监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/sharedcalls">防止缓存击穿之进程内共享调用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/sql-cache">DB缓存机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/zrpc">zRPC使用介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/redis-cache">go-zero缓存设计之持久层缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/buiness-cache">go-zero缓存设计之业务层缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/go-queue">go-zero 分布式定时任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/go-zero-looklook">使用go-zero开发一个旅游系统go-zero-looklook</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/extension/datacenter">go-zero 实现一个中台系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/extension/stream">流数据处理利器</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/problem/in-use">问题汇总</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>go-zero 实现一个中台系统</h1></header><blockquote><p>作者：Jack Luo</p><p>原文连接：<a href="https://www.cnblogs.com/jackluo/p/14148518.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/jackluo/p/14148518.html</a></p></blockquote><p>[TOC]</p><p>最近发现golang社区里出了一个新星的微服务框架，来自好未来，光看这个名字，就很有奔头，之前，也只是玩过go-micro，其实真正的还没有在项目中运用过，只是觉得 微服务，grpc 这些很高大尚，还没有在项目中，真正的玩过，我看了一下官方提供的工具真的很好用，只需要定义好，舒适文件jia结构 都生成了，只需要关心业务，加上最近 有个投票的活动，加上最近这几年中台也比较火，所以决定玩一下，</p><blockquote><p>开源地址: <a href="https://github.com/jackluo2012/datacenter" target="_blank" rel="noopener noreferrer">https://github.com/jackluo2012/datacenter</a></p></blockquote><p>先聊聊中台架构思路吧：</p><p><img src="https://img2020.cnblogs.com/blog/203395/202012/203395-20201217094615171-335437652.jpg"></p><p>中台的概念大概就是把一个一个的app 统一起来，反正我是这样理解的。</p><p>先聊用户服务吧，现在一个公司有很多的公众号、小程序、微信的、支付宝的，还有 xxx xxx，很多的平台，每次开发的时候，我们总是需要做用户登陆的服务，不停的复制代码，然后我们就在思考能不能有一套独立的用户服务，只需要告诉我你需要传个你要登陆的平台(比如微信)，微信登陆，需要的是客户端返回给服务端一个code ，然后服务端拿着这个code去微信获取用户信息，反正大家都明白。</p><p>我们决定，将所有的信息弄到配置公共服务中去，里面再存微信、支付宝以及其它平台的appid、appkey、还有支付的appid、appkey，这样就写一套。</p><hr><p>最后说说实现吧，整个就一个repo：</p><ul><li>网关，我们用的是: go-zero的Api服务</li><li>其它它的是服务，我们就是用的go-zero的rpc服务</li></ul><p>看下目录结构</p><p><img src="https://img2020.cnblogs.com/blog/203395/202012/203395-20201209110504600-317546535.png"></p><p>整个项目完成，我一个人操刀，写了1个来星期，我就实现了上面的中台系统。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="datacenter-api服务">datacenter-api服务<a class="hash-link" href="#datacenter-api服务" title="Direct link to heading">​</a></h2><p>先看官方文档 <a href="https://go-zero.dev/cn/" target="_blank" rel="noopener noreferrer">https://go-zero.dev/cn/</a></p><p>我们先把网关搭建起来：</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜ blogs </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> datacenter </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> datacenter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜ datacenter go mod init datacenter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go: creating new go.mod: module datacenter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜ datacenter</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>查看book目录：</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── go.mod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0 directories, 1 file</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="创建api文件">创建api文件<a class="hash-link" href="#创建api文件" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter goctl api -o datacenter.api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── datacenter.api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── user.api  #用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── votes.api #投票</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── search.api #搜索</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── questions.api #问答</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── go.mod</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="定义api服务">定义api服务<a class="hash-link" href="#定义api服务" title="Direct link to heading">​</a></h3><p>分别包含了上面的 <strong>公共服务</strong>，<strong>用户服务</strong>，<strong>投票活动服务</strong></p><p>datacenter.api的内容:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">info(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title: &quot;中台系统&quot;// TODO: add title</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desc: &quot;中台系统&quot;// TODO: add description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    author: &quot;jackluo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email: &quot;net.webjoy@gmail.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;user.api&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;votes.api&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;search.api&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;questions.api&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//获取 应用信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Beid {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid int64 `json:&quot;beid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Token {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Token string `json:&quot;token&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type WxTicket {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ticket string `json:&quot;ticket&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Application {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sname       string `json:&quot;Sname&quot;`       //名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Logo        string `json:&quot;logo&quot;`        // login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Isclose     int64  `json:&quot;isclose&quot;`     //是否关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Fullwebsite string `json:&quot;fullwebsite&quot;` // 全站名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type SnsReq {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid   int64  `json:&quot;ptyid&quot;`    //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BackUrl string `json:&quot;back_url&quot;` //登陆返回的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type SnsResp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid    int64  `json:&quot;ptyid&quot;`     //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Appid    string `json:&quot;appid&quot;`     //sns 平台的id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Title    string `json:&quot;title&quot;`     //名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LoginUrl string `json:&quot;login_url&quot;` //微信登陆的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type WxShareResp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Appid     string `json:&quot;appid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Timestamp int64  `json:&quot;timestamp&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Noncestr  string `json:&quot;noncestr&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Signature string `json:&quot;signature&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取站点的信息&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler appInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /common/appinfo (Beid) returns (Application)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取站点的社交属性信息&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler snsInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /common/snsinfo (SnsReq) returns (SnsResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取分享的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler wxTicket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /common/wx/ticket (SnsReq) returns (WxShareResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//上传需要登陆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jwt: Auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;七牛上传凭证&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler qiuniuToken</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /common/qiuniu/token (Beid) returns (Token)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>user.api内容</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">//注册请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type RegisterReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // TODO: add members here and delete this comment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mobile   string `json:&quot;mobile&quot;` //基本一个手机号码就完事</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Password string `json:&quot;password&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Smscode string `json:&quot;smscode&quot;` //短信码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//登陆请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type LoginReq struct{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mobile   string `json:&quot;mobile&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type int64 `json:&quot;type&quot;`    //1.密码登陆，2.短信登陆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Password string `json:&quot;password&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//微信登陆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type WxLoginReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid      int64  `json:&quot;beid&quot;` //应用id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Code string `json:&quot;code&quot;` //微信登陆密钥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid     int64  `json:&quot;ptyid&quot;` //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//返回用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type UserReply struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auid       int64  `json:&quot;auid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uid       int64  `json:&quot;uid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid      int64  `json:&quot;beid&quot;` //应用id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid     int64  `json:&quot;ptyid&quot;` //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Username string `json:&quot;username&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mobile   string `json:&quot;mobile&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Nickname string `json:&quot;nickname&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Openid string `json:&quot;openid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Avator string `json:&quot;avator&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JwtToken</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//返回APPUser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type AppUser struct{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uid       int64  `json:&quot;uid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auid       int64  `json:&quot;auid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid      int64  `json:&quot;beid&quot;` //应用id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid     int64  `json:&quot;ptyid&quot;` //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Nickname string `json:&quot;nickname&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Openid string `json:&quot;openid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Avator string `json:&quot;avator&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type LoginAppUser struct{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uid       int64  `json:&quot;uid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auid       int64  `json:&quot;auid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid      int64  `json:&quot;beid&quot;` //应用id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid     int64  `json:&quot;ptyid&quot;` //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Nickname string `json:&quot;nickname&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Openid string `json:&quot;openid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Avator string `json:&quot;avator&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JwtToken</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type JwtToken struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AccessToken  string `json:&quot;access_token,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AccessExpire int64  `json:&quot;access_expire,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RefreshAfter int64  `json:&quot;refresh_after,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type UserReq struct{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auid       int64  `json:&quot;auid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uid       int64  `json:&quot;uid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beid      int64  `json:&quot;beid&quot;` //应用id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ptyid     int64  `json:&quot;ptyid&quot;` //对应平台</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Request {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name string `path:&quot;name,options=you|me&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message string `json:&quot;message&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /user/ping ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler register</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /user/register (RegisterReq) returns (UserReply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /user/login (LoginReq) returns (UserReply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler wxlogin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /user/wx/login (WxLoginReq) returns (LoginAppUser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler code2Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /user/wx/login () returns (LoginAppUser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jwt: Auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    middleware: Usercheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler userInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /user/dc/info (UserReq) returns (UserReply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>votes.api 投票内容</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 投票活动api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Actid struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Actid       int64  `json:&quot;actid&quot;` //活动id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type VoteReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Aeid       int64  `json:&quot;aeid&quot;` // 作品id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Actid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type VoteResp struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VoteReq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Votecount       int64  `json:&quot;votecount&quot;` //投票票数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Viewcount       int64  `json:&quot;viewcount&quot;` //浏览数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 活动返回的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ActivityResp struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Actid           int64  `json:&quot;actid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Title           string  `json:&quot;title&quot;` //活动名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Descr           string  `json:&quot;descr&quot;` //活动描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StartDate       int64  `json:&quot;start_date&quot;` //活动时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EnrollDate      int64  `json:&quot;enroll_date&quot;` //投票时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EndDate         int64  `json:&quot;end_date&quot;` //活动结束时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Votecount       int64  `json:&quot;votecount&quot;` //当前活动的总票数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Viewcount       int64  `json:&quot;viewcount&quot;` //当前活动的总浏览数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type            int64 `json:&quot;type&quot;` //投票方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Num             int64 `json:&quot;num&quot;` //投票几票</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//报名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type EnrollReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Actid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name        string  `json:&quot;name&quot;` // 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Address         string  `json:&quot;address&quot;` //地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Images          []string  `json:&quot;images&quot;` //作品图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Descr           string  `json:&quot;descr&quot;` // 作品描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 作品返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type EnrollResp struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Actid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Aeid        int64 `json:&quot;aeid&quot;` // 作品id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name        string  `json:&quot;name&quot;` // 名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Address         string  `json:&quot;address&quot;` //地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Images          []string  `json:&quot;images&quot;` //作品图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Descr           string  `json:&quot;descr&quot;` // 作品描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Votecount       int64  `json:&quot;votecount&quot;` //当前活动的总票数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Viewcount       int64  `json:&quot;viewcount&quot;` //当前活动的总浏览数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: votes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取活动的信息&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler activityInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /votes/activity/info (Actid) returns (ActivityResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;活动访问+1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler activityIcrView</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /votes/activity/view (Actid) returns (ActivityResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取报名的投票作品信息&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler enrollInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /votes/enroll/info (VoteReq) returns (EnrollResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取报名的投票作品列表&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler enrollLists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /votes/enroll/lists (Actid) returns(EnrollResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jwt: Auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: votes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    middleware: Usercheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;投票&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler vote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /votes/vote (VoteReq) returns (VoteResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler enroll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /votes/enroll (EnrollReq) returns (EnrollResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>questions.api 问答内容:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 问答 抽奖 开始</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: questions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取活动的信息&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler activitiesInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /questions/activities/info (Actid) returns (ActivityResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取奖品信息&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler awardInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /questions/award/info (Actid) returns (ActivityResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler awardList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /questions/award/list (Actid) returns (ActivityResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type AnswerReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActivityId  int64 `json:&quot;actid&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Answers string `json:&quot;answers&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Score   string `json:&quot;score&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type QuestionsAwardReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActivityId  int64 `json:&quot;actid&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnswerId    int64 `json:&quot;answerid&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type AnswerResp struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Answers string `json:&quot;answers&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Score   string `json:&quot;score&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type AwardConvertReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UserName    string `json:&quot;username&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Phone       string `json:&quot;phone&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LotteryId   int64 `json:&quot;lotteryid&quot;` </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jwt: Auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: questions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    middleware: Usercheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取题目&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler lists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /questions/lists (VoteReq) returns (AnswerResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;提交答案&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /questions/change (AnswerReq) returns (VoteResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;获取分数&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler grade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /questions/grade (VoteReq) returns (VoteResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;开始转盘&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler turntable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /questions/lottery/turntable (EnrollReq) returns (EnrollResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;填写中奖信息人&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler lottery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /questions/lottery/convert (AwardConvertReq) returns (EnrollResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 问答 抽奖 结束</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>search.api 搜索</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type SearchReq struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Keyword string `json:&quot;keyword&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Page string `json:&quot;page&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Size string `json:&quot;size&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type SearchResp struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Data []ArticleReq `json:&quot;data&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ArticleReq struct{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NewsId string `json:&quot;NewsId&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NewsTitle string `json:&quot;NewsTitle&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ImageUrl string `json:&quot;ImageUrl&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    group: search</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    middleware: Admincheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service datacenter-api {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @doc(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        summary: &quot;搜索&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler article</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /search/article (SearchReq) returns (SearchResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler articleInit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get /search/articel/init (SearchReq) returns (SearchResp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @handler articleStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    post /search/articel/store (ArticleReq) returns (ArticleReq)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面基本上写就写的API及文档的思路</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="生成datacenter-api服务">生成datacenter api服务<a class="hash-link" href="#生成datacenter-api服务" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter goctl api go -api datacenter.api -dir .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter treer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── datacenter.api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── datacenter-api.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── go.mod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── appinfohandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── qiuniutokenhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── snsinfohandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── votesverificationhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── wxtickethandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── routes.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── code2sessionhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── loginhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── pinghandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── registerhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── userinfohandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── wxloginhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── votes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── activityicrviewhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── activityinfohandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── enrollhandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── enrollinfohandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── enrolllistshandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       └── votehandler.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── appinfologic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── qiuniutokenlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── snsinfologic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── votesverificationlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── wxticketlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── code2sessionlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── loginlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── pinglogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── registerlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── userinfologic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── wxloginlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── votes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── activityicrviewlogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── activityinfologic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── enrollinfologic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── enrolllistslogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── enrolllogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       └── votelogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── usercheckmiddleware.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── servicecontext.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── types.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── datacenter.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14 directories, 43 files</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>我们打开 <code>etc/datacenter-api.yaml</code> 把必要的配置信息加上</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> datacenter</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Log</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8857</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">AccessSecret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 你的jwtwon Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">AccessExpire</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">86400</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">CacheRedis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Pass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">UserRpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> user.rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">CommonRpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> common.rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">VotesRpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> votes.rpc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面的 <code>UserRpc</code>， <code>CommonRpc</code> ,还有 <code>VotesRpc</code> 这些我先写上，后面再来慢慢加。</p><p>我们先来写 <code>CommonRpc</code> 服务。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="commonrpc服务">CommonRpc服务<a class="hash-link" href="#commonrpc服务" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="新建项目目录">新建项目目录<a class="hash-link" href="#新建项目目录" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter mkdir -p common/rpc &amp;&amp; cd common/rpc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>直接就新建在了，datacenter目录中，因为common 里面，可能以后会不只会提供rpc服务，可能还有api的服务,所以又加了rpc目录</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="goctl创建模板">goctl创建模板<a class="hash-link" href="#goctl创建模板" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  rpc goctl rpc template -o=common.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  rpc ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">common.proto</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>往里面填入内容：</p><div class="codeBlockContainer_J+bg language-protobufbuf theme-code-block"><div class="codeBlockContent_csEI protobufbuf"><pre tabindex="0" class="prism-code language-protobufbuf codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  rpc cat common.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option go_package = &quot;common&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package common;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message BaseAppReq{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 beid=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message BaseAppResp{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 beid=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string logo=2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string sname=3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 isclose=4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string fullwebsite=5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 请求的api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message AppConfigReq {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 beid=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 ptyid=2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 返回的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message AppConfigResp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 id=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 beid=2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64 ptyid=3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string appid=4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string appsecret=5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string title=6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service Common {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpc GetAppConfig(AppConfigReq) returns(AppConfigResp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpc GetBaseApp(BaseAppReq) returns(BaseAppResp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="gotcl生成rpc服务">gotcl生成rpc服务<a class="hash-link" href="#gotcl生成rpc服务" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  rpc goctl rpc proto -src common.proto -dir </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protoc  -I</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/Users/jackluo/works/blogs/datacenter/common/rpc common.proto --go_out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">plugins</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">grpc:/Users/jackluo/works/blogs/datacenter/common/rpc/common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Done.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜ rpc tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └── common.pb.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── commonclient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └── common.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └── common.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └── config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├── getappconfiglogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └── getbaseapplogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └── commonserver.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── servicecontext.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8 directories, 10 files</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>基本上，就把所有的目录规范和结构的东西都生成了，就不用纠结项目目录了，怎么放了，怎么组织了。</p><p>看一下，配置信息，里面可以写入mysql和其它redis的信息：</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> common.rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">ListenOn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8081</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Mysql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">DataSource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">admin@tcp(127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3306)/datacenter</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">charset=utf8</span><span class="token important">&amp;parseTime=true&amp;loc=Asia%2FShanghai</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">CacheRedis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Pass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> common.rpc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>我们再来加上数据库服务：</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  rpc cd ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  common ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  common pwd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/Users/jackluo/works/blogs/datacenter/common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  common goctl model mysql datasource -url=&quot;root:admin@tcp(127.0.0.1:3306)/datacenter&quot; -table=&quot;base_app&quot; -dir ./model -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">➜  common tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── baseappmodel.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── vars.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── common.pb.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── common.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── common.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── commonclient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── common.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── common.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │   └── config.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │   ├── getappconfiglogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │   └── getbaseapplogic.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │   └── commonserver.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            └── servicecontext.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10 directories, 12 files</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这样基本的一个 <code>rpc</code> 就写完了，然后我们将rpc 和model 还有api串连起来，这个官方的文档已经很详细了，这里就只是贴一下代码：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  common cat rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/stores/cache&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/zrpc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcServerConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mysql </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataSource </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CacheRedis cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>再在svc中修改：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  common cat rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">svc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">servicecontext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/common/model&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/common/rpc/internal/config&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/stores/sqlx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ServiceContext </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c              config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AppConfigModel model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AppConfigModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BaseAppModel   model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseAppModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewServiceContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServiceContext </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sqlx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewMysql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mysql</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apm </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewAppConfigModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheRedis</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bam </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewBaseAppModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheRedis</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">              c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AppConfigModel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apm</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BaseAppModel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   bam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>上面的代码已经将 <code>rpc</code> 和 <code>model</code> 数据库关联起来了，我们现在再将 <code>rpc</code> 和 <code>api</code> 关联起来：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter cat internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/stores/cache&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/rest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/zrpc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RestConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auth </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccessSecret </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccessExpire </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UserRpc   zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcClientConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CommonRpc zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcClientConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VotesRpc  zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcClientConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CacheRedis cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterConf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>加入 <code>svc</code> 服务中：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">➜  datacenter cat internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">svc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">servicecontext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/common/rpc/commonclient&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/internal/config&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/internal/middleware&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/shared&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/user/rpc/userclient&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/votes/rpc/votesclient&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/logx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/stores/cache&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/stores/redis&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/syncx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/rest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/zrpc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;google.golang.org/grpc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ServiceContext </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Config           config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GreetMiddleware1 rest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GreetMiddleware2 rest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Usercheck        rest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UserRpc          userclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">User </span><span class="token comment" style="color:#999988;font-style:italic">//用户</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CommonRpc        commonclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Common</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VotesRpc         votesclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Votes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cache            cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisConn        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">timeInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> invoker grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryInvoker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;调用 %s 方法 耗时: %v\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewServiceContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServiceContext </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ur </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> userclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MustNewClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UserRpc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithUnaryClientInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> commonclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewCommon</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MustNewClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CommonRpc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithUnaryClientInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> votesclient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewVotes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MustNewClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VotesRpc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zrpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithUnaryClientInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ca </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewCache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheRedis</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> syncx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewSharedCalls</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewCacheStat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;dc&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shared</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrNotFound</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rcon </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewRedis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheRedis</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheRedis</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CacheRedis</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">           c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GreetMiddleware1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> greetMiddleware1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GreetMiddleware2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> greetMiddleware2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Usercheck</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        middleware</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewUserCheckMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserRpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          ur</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CommonRpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        cr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        VotesRpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         vr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Cache</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">            ca</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RedisConn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        rcon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这样基本上，我们就可以在 <code>logic</code> 的文件目录中调用了：</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">cat internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logic</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">appinfologic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/internal/svc&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/internal/types&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/shared&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/common/model&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;datacenter/common/rpc/common&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/zeromicro/go-zero/core/logx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> AppInfoLogic </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Logger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx    context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    svcCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewAppInfoLogic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> svcCtx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">svc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> AppInfoLogic </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> AppInfoLogic</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Logger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> logx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        svcCtx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> svcCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">AppInfoLogic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AppInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Beid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">appconfig </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseAppResp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//检查 缓存中是否有值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetCache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetcacheBaseAppIdPrefix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Beid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> appconfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> shared</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrNotFound </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        appconfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CommonRpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBaseApp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseAppReq</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Beid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Beid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetCache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetcacheBaseAppIdPrefix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Beid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> appconfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>这样，基本就连接起来了，其它基本上就不用改了，<code>UserRPC</code>， <code>VotesRPC</code> 类似，这里就不在写了。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="使用心得">使用心得<a class="hash-link" href="#使用心得" title="Direct link to heading">​</a></h2><p><code>go-zero</code> 的确香，因为它有一个 <code>goctl</code> 的工具，他可以自动的把代码结构全部的生成好，我们就不再去纠结，目录结构 ，怎么组织，没有个好几年的架构能力是不好实现的，有什么规范那些，并发，熔断，完全不用，考虑其它的，专心的实现业务就好，像微服务，还要有服务发现，一系列的东西，都不用关心，因为 <code>go-zero</code> 内部已经实现了。</p><p>我写代码也写了有10多年了，之前一直用的 php，比较出名的就 laravel，thinkphp，基本上就是模块化的，像微服务那些实现真的有成本，但是你用上go-zero，你就像调api接口一样简单的开发，其它什么服务发现，那些根本就不用关注了，只需要关注业务。</p><p>一个好的语言，框架，他们的底层思维，永远都是效率高，不加班的思想，我相信go-zero会提高你和你团队或是公司的效率。go-zero的作者说，他们有个团队专门整理go-zero框架，目的也应该很明显，那就是提高，他们自己的开发效率，流程化，标准化，是提高工作效率的准则，像我们平时遇到了问题，或是遇到了bug，我第一个想到的不是怎么去解决我的bug，而是在想我的流程是不是有问题，我的哪个流程会导致bug，最后我相信 <code>go-zero</code> 能成为 <strong>微服务开发</strong> 的首选框架。</p><p>最后说说遇到的坑吧：</p><ul><li><code>grpc</code></li></ul><p><code>grpc</code> 本人第一次用，然后就遇到了，有些字符为空时，字段值不显示的问题：</p><p>通过 <code>grpc</code> 官方库中的 <code>jsonpb</code> 来实现，官方在它的设定中有一个结构体用来实现 <code>protoc buffer</code> 转换为JSON结构，并可以根据字段来配置转换的要求。</p><ul><li>跨域问题</li></ul><p><code>go-zero</code> 中设置了，感觉没有效果，大佬说通过nginx 设置，后面发现还是不行，最近强行弄到了一个域名下，后面有时间再解决。</p><ul><li><code>sqlx</code></li></ul><p><code>go-zero</code> 的 <code>sqlx</code> 问题，这个真的费了很长的时间：</p><blockquote><p><code>time.Time</code> 这个数据结构，数据库中用的是 timestamp 这个 比如我的字段 是delete_at 默认数库设置的是null ，结果插入的时候，就报了 <code>Incorrect datetime value: &#x27;0000-00-00&#x27; for column &#x27;deleted_at&#x27; at row 1&quot;}</code> 这个错，查询的时候报 <code>deleted_at\&quot;: unsupported Scan, storing driver.Value type \u003cnil\u003e into type *time.Time&quot;</code>
后面果断去掉了这个字段，字段上面加上 <code>.omitempty</code> 这个标签，好像也有用，<code>db:&quot;.omitempty&quot;</code></p></blockquote><p>其次就是这个 <code>Conversion from collation utf8_general_ci into utf8mb4_unicode_ci</code>，这个导致的大概原因是，现在都喜欢用emj表情了，mysql数据识别不了。</p><ul><li>数据连接</li></ul><p><code>mysql</code> 这边照样按照原始的方式,将配置文件修改编码格式，重新创建数据库，并且设置数据库编码为utf8mb4，排序规则为 <code>utf8mb4_unicode_ci</code>。</p><p><strong>这样的话,所有的表还有string字段都是这个编码格式,如果不想所有的都是,可以单独设置,这个不是重点.因为在navicat上都好设置,手动点一下就行了</strong>。</p><p>重点来了：golang中使用的是 <code>github.com/go-sql-driver/mysql</code> 驱动，将连接 <code>mysql</code>的 <code>dsn</code>（因为我这使用的是gorm，所以dsn可能跟原生的格式不太一样，不过没关系， 只需要关注 <code>charset</code> 和 <code>collation</code> 就行了）
<code>root:password@/name?parseTime=True&amp;loc=Local&amp;charset=utf8</code> 修改为：
<code>root:password@/name?parseTime=True&amp;loc=Local&amp;charset=utf8mb4&amp;collation=utf8mb4_unicode_ci</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zeromicro/zero-doc/tree/main/website/docs/extension/datacenter.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/extension/go-zero-looklook"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">使用go-zero开发一个旅游系统go-zero-looklook</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/extension/stream"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">流数据处理利器</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#datacenter-api服务" class="table-of-contents__link toc-highlight">datacenter-api服务</a><ul><li><a href="#创建api文件" class="table-of-contents__link toc-highlight">创建api文件</a></li><li><a href="#定义api服务" class="table-of-contents__link toc-highlight">定义api服务</a></li><li><a href="#生成datacenter-api服务" class="table-of-contents__link toc-highlight">生成datacenter api服务</a></li></ul></li><li><a href="#commonrpc服务" class="table-of-contents__link toc-highlight">CommonRpc服务</a><ul><li><a href="#新建项目目录" class="table-of-contents__link toc-highlight">新建项目目录</a></li><li><a href="#goctl创建模板" class="table-of-contents__link toc-highlight">goctl创建模板</a></li><li><a href="#gotcl生成rpc服务" class="table-of-contents__link toc-highlight">gotcl生成rpc服务</a></li></ul></li><li><a href="#使用心得" class="table-of-contents__link toc-highlight">使用心得</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro/brief">docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/go-zero/shared_invite/zt-10ruju779-BE4y6lQNB_R21samtyKTgA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Chat Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 go-zero.dev, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f1cb22ad.js"></script>
<script src="/assets/js/main.9a22f610.js"></script>
</body>
</html>